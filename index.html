<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Training Audit | Third wave coffee</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
  <style>
    .fade-in { opacity: 0; animation: fadeIn 0.6s forwards; }
    @keyframes fadeIn { to { opacity: 1; } }
    .report-box {
      border-radius: 18px;
      background: #f8fafc;
      border: 2px solid #e0e7ef;
      box-shadow: 0 2px 8px #e0e7ef77;
    }
    .section-title {
      font-size: 1.1rem;
      font-weight: bold;
      text-align: center;
      margin: 0;
      padding: 8px 0 8px 0;
      color: #293241;
    }
    .autotable-header {
      color: #23272f !important;
      background: #e3e8f2 !important;
      font-weight: bold !important;
      font-size: 11px !important;
      text-align: center !important;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const params = new URLSearchParams(window.location.search);
    const auditorName = params.get('auditorName')||params.get('name')||'';
    const auditorId   = params.get('auditorId')||params.get('id')||'';
    const LOG_ENDPOINT = 'https://script.google.com/macros/s/AKfycbz9tedGmiD8XoRdMxbpI_UB-8aRQ5jdM_92bzedq27MQFPUmQmRlryC-ewNflCedVMD2w/exec';
    const safeVibrate = pattern => { if(navigator?.vibrate) navigator.vibrate(pattern); };
    const safeLS = { get:k=>{try{return localStorage.getItem(k)}catch{return null}}, set:(k,v)=>{try{localStorage.setItem(k,v)}catch{}}, clear:()=>{try{localStorage.clear()}catch{}} };

    // Checklist Data & Scoring
    const SECTIONS = [
      { id:'TrainingMaterials', title:'Training Materials', items:[
        {id:'TM_1',q:'FRM available at store?',w:1},
        {id:'TM_2',q:'BRM available at store?',w:1},
        {id:'TM_3',q:'One-pager – Hot/Cue Cards displayed?',w:1},
        {id:'TM_4',q:'One-pager – Cold/Cue Cards displayed?',w:1},
        {id:'TM_5',q:'Dial-in One-pager visible?',w:2},
        {id:'TM_6',q:'New-launch learning material posted?',w:1},
        {id:'TM_7',q:'COFFEE & HD Playbook in store?',w:1},
        {id:'TM_8',q:'MSDS, chemical chart and Shelf life chart available?',w:1},
        {id:'TM_9',q:'Career Progression Chart & Reward Poster displayed?',w:1}
      ]},
      { id:'LMS', title:'LMS Usage', items:[
        {id:'LMS_1',q:'Orientation & Induction completed within 3 days of joining?',w:4, wneg:-4},
        {id:'LMS_2',q:'All assessments & knowledge checks on LMS?',w:4, wneg:-4},
        {id:'LMS_3',q:'Team uses LMS for new info & comms?',w:2}
      ]},
      { id:'Buddy', title:'Buddy Trainer Availability & Capability', items:[
        {id:'Buddy_1',q:'Does the café have at least 2 certified Buddy Trainers?',w:2},
        {id:'Buddy_2',q:'Have Buddy Trainers completed their Skill Check?',w:2},
        {id:'Buddy_3',q:'Are trainees rostered with Buddy Trainers and working in the same shift?',w:1},
        {id:'Buddy_4',q:'Have Buddy Trainers attended the BT workshop?',w:2},
        {id:'Buddy_5',q:'Can Buddy Trainers explain the 4-step training process effectively?',w:2},
        {id:'Buddy_6',q:'Can Buddy Trainers navigate Zing LMS flawlessly?',w:1}
      ]},
      { id:'NewJoiner', title:'New Joiner Training & Records', items:[
        {id:'NJ_1',q:'Is the OJT book available for all partners?',w:1},
        {id:'NJ_2',q:'Are trainees referring to the OJT book and completing their skill checks?',w:1},
        {id:'NJ_3',q:'Is training progression aligned with the Training Calendar/Plan?',w:1},
        {id:'NJ_4',q:'Are team members aware of post-barista training progressions?',w:1},
        {id:'NJ_5',q:'Have managers completed SHLP training as per the calendar?',w:2},
        {id:'NJ_6',q:'Are there at least 2 FOSTAC-certified managers in the store?',w:2},
        {id:'NJ_7',q:'Is ASM/SM training completed as per the Training Calendar?',w:2}
      ]},
      { id:'PartnerKnowledge', title:'Partner Knowledge', items:[
        {id:'PK_1',q:'Are team members aware of current company communications?',w:2},
        {id:'PK_2',q:'Ask a team member to conduct a Coffee Tasting & Sampling',w:2},
        {id:'PK_3',q:'Is Sampling being conducted as per the set guidelines?',w:2},
        {id:'PK_4',q:'Is Coffee Tasting engaging and effective?',w:2},
        {id:'PK_5',q:'Are team members aware of manual brewing methods and standards?',w:2},
        {id:'PK_6',q:'Are partners following grooming standards?',w:2},
        {id:'PK_7',q:'Pop-quiz key topics passed?',w:3, wneg:-3}
      ]},
      { id:'TSA', title:'TSA - Training Skill Assessment', items:[
        {id:'TSA_1',q:'Partner 1 – Hot & Cold stations work?',w:10},
        {id:'TSA_2',q:'Partner 2 – Food station cleanliness?',w:10},
        {id:'TSA_3',q:'Partner 3 – Customer Service quality?',w:10}
      ]},
      { id:'CustomerExperience', title:'Customer Experience', items:[
        {id:'CX_1',q:'Is background music at appropriate volume?',w:1},
        {id:'CX_2',q:'Is store temperature comfortable?',w:1},
        {id:'CX_3',q:'Are washrooms clean and well-maintained?',w:1},
        {id:'CX_4',q:'Is Wi-Fi available & functioning?',w:1},
        {id:'CX_5',q:'Are marketing & VM displays correct?',w:2},
        {id:'CX_6',q:'Is store furniture clean & well-kept?',w:1},
        {id:'CX_7',q:'What do you understand by MA, CPI, QA scores?',w:1},
        {id:'CX_8',q:'What was the latest Mystery Audit score for the store?',w:1},
        {id:'CX_9',q:'Top 2 CX opportunity areas last month?',w:1}
      ]},
      { id:'ActionPlan', title:'Action Plan & Continuous Improvement', items:[
        {id:'AP_1',q:'Concerns addressed within 48hrs?',w:1, wneg:-1},
        {id:'AP_2',q:'Action points closed/work-in-progress?',w:2},
        {id:'AP_3',q:'Managers aware of action plan?',w:2}
      ]}
    ];
    const optionColors = { yes:'green', no:'red', na:'yellow' };
    const options = Object.entries(optionColors);

    function App(){
      const [resp,setResp]=useState(()=>JSON.parse(safeLS.get('resp')||'{}'));
      const [storeName,setStoreName]=useState(safeLS.get('storeName')||'');
      const [storeId,setStoreId]=useState(safeLS.get('storeId')||'');
      const [imgs,setImgs]=useState(()=>JSON.parse(safeLS.get('imgs')||'{}'));
      const [downloading,setDownloading]=useState(false);

      useEffect(()=>{safeLS.set('resp',JSON.stringify(resp));safeLS.set('storeName',storeName);safeLS.set('storeId',storeId);safeLS.set('imgs',JSON.stringify(imgs));},[resp,storeName,storeId,imgs]);

      const handleOption=(sec,it,val)=>{
        const key=`${sec.id}_${it.id}`;
        setResp(p=>({...p,[key]:val}));
        if(navigator?.vibrate){
          if(val==='yes')safeVibrate(50);
          else if(val==='no')safeVibrate([50,50]);
        }
      };
      const handleTSA=(sec,it,val)=>{
        const key=`${sec.id}_${it.id}`;
        setResp(p=>({...p,[key]:val}));
        if(navigator?.vibrate) safeVibrate(50);
      };
      const addImages=(sec,e)=>{
        Array.from(e.target.files).forEach(f=>{
          EXIF.getData(f,function(){
            const r=new FileReader();
            r.onload=ev=>setImgs(p=>({...p,[sec.id]:[...(p[sec.id]||[]),ev.target.result]}));
            r.readAsDataURL(f);
          });
        });
        e.target.value=null;
      };
      const scrollTo=(id)=>{
        const el=document.getElementById(id);if(el)el.scrollIntoView({behavior:'smooth',block:'center'});
      };
      // Check completion
      const allDone = storeName.trim() && storeId.trim() &&
        SECTIONS.every(sec=>sec.items.every(it=>resp[`${sec.id}_${it.id}`]!=null));

      // SUBMIT & PDF
      const handleSubmit=async e=>{
        e.preventDefault();
        if(!allDone){safeVibrate([200,200]);return;}
        setDownloading(true);
        // Score calculation
        let total=0, max=0, sectionScores={}, sectionMax={};
        SECTIONS.forEach(sec=>{
          let secTotal=0, secMax=0;
          sec.items.forEach(it=>{
            const key=`${sec.id}_${it.id}`,r=resp[key];
            if(sec.id==='TSA'){const v=parseInt(r)||0; secTotal+=v; secMax+=it.w;}
            else{
              if(r==='yes')secTotal+=it.w;
              else if(r==='no' && it.wneg)secTotal+=it.wneg;
              if(r!=='na')secMax+=Math.abs(it.w);
            }
          });
          sectionScores[sec.id]=secTotal;
          sectionMax[sec.id]=secMax;
          total+=secTotal;max+=secMax;
        });
        const pct = max?Math.round((total/max)*100):0;
        const completion=new Date().toLocaleString('en-GB',{hour12:false});
        // Logging
        const data = new URLSearchParams({
          date: completion,
          auditorName, auditorId, storeName, storeId,
          score: total, percentage: pct
        });
        try {
          await fetch(LOG_ENDPOINT, { method: "POST", body: data });
        } catch {}
        safeVibrate(100);
        // PDF Generation
        const {jsPDF}=window.jspdf;
const doc=new jsPDF({orientation:'portrait',unit:'mm'});
const sectionBg = [
  '#E3F6FC','#FEF6E4','#E4F7EE','#FFF1F6','#F1F2FB',
  '#FFF5DA','#F8F9F9','#F5F6F6'
];
        // HEADER
        doc.setFillColor('#F7F8FA'); doc.rect(10,10,190,20,'F');
        doc.setFontSize(19); doc.setFont('helvetica','bold');
        doc.setTextColor('#263140'); 
        doc.text(`Training Audit | ${storeName}`, 105, 19, {align:'center'});
        doc.setFontSize(10); doc.setFont('helvetica','normal'); doc.setTextColor('#24272e');
        doc.text(`Date/Time: ${completion}`,10,28);
        doc.text(`Auditor: ${auditorName}`,65,28);
        doc.text(`StoreID: ${storeId}`,130,28);
        doc.setFontSize(14); doc.setTextColor('#086972');
        doc.text(`Score: ${total} / ${max} | ${pct}%`, 200, 28, {align:'right'});

        let y = 36;
        for(let s=0;s<SECTIONS.length;s++){
          const sec=SECTIONS[s];
          const bg = sectionBg[s%sectionBg.length];
          // Pre-box: measure table height
          const rows = sec.items.map(it=>{
            const key = `${sec.id}_${it.id}`;
            const r = resp[key];
            let respText = (sec.id==='TSA')?r:(r==='yes'?'Yes':r==='no'?'No':r==='na'?'NA':r);
            let score = (sec.id==='TSA')? (parseInt(r)||0):(r==='yes'?it.w:(r==='no'&&it.wneg?it.wneg:0));
            return [it.q, respText, score];
          });
     // Section box (draw after table+images)
  // Draw section title
  doc.setFont('helvetica','bold'); doc.setFontSize(13);
  doc.setFillColor(bg);
  // Section title in box
  doc.roundedRect(13, y, 184, 12, 9, 9, 'F');
  doc.setFontSize(12); doc.setTextColor('#23272f');
  doc.text(`${sec.title}  (Score: ${sectionScores[sec.id]} / ${sectionMax[sec.id]})`, 105, y+8, {align:'center'});
  // Table below title, inside box
  doc.autoTable({
    startY: y+12,
    head:[['Question','Response','Score']],
    body: rows,
    margin:{left:18,right:18},
    styles:{fontSize:9,cellPadding:2,textColor:'#23272f'},
    headStyles:{fillColor:'#dbeafe',textColor:'#23272f',fontStyle:'bold'},
    tableLineColor:'#c3dafe',tableLineWidth:0.7,
    theme:'grid',
    showHead:'everyPage'
  });
  let nextY = doc.lastAutoTable.finalY+2;
  // IMAGES (below table, still in section box)
  let imgH = 0;
  if(imgs[sec.id] && imgs[sec.id].length){
    imgs[sec.id].forEach((src, i)=>{
      if(nextY>265){ doc.addPage(); nextY=20;}
      doc.addImage(src,'JPEG',18+30*i,nextY,24,24);
      imgH = Math.max(imgH, 26);
    });
    nextY += imgH+2;
  }
  // Now draw the box *after* knowing full height
  const boxH = nextY-y+3;
  doc.setDrawColor('#b5bfc7');
  doc.setLineWidth(1.1);
  doc.roundedRect(13, y, 184, boxH, 9, 9);
  y = nextY+8;
  if(y>220 && s!==SECTIONS.length-1){ doc.addPage(); y=20;}
}
doc.save(`audit_${storeName}_${Date.now()}.pdf`);
      };

      const resetAll=()=>{safeLS.clear();setResp({});setStoreName('');setStoreId('');setImgs({});safeVibrate([200,200]);};

      // UI
      return(
        <form onSubmit={handleSubmit} className="space-y-6 p-3 pt-4 max-w-2xl mx-auto">
          <h1 className="text-xl sm:text-2xl font-bold text-center mb-2">Training Audit | Third wave coffee</h1>
          <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-2">
            <div><label className="block text-xs font-semibold">Auditor Name</label>
              <input id="auditorName" readOnly value={auditorName} className="w-full p-2 border rounded bg-gray-100"/></div>
            <div><label className="block text-xs font-semibold">Auditor ID</label>
              <input id="auditorId" readOnly value={auditorId} className="w-full p-2 border rounded bg-gray-100"/></div>
            <div><label className="block text-xs font-semibold">Store Name</label>
              <input id="storeName" value={storeName} onChange={e=>setStoreName(e.target.value)} required className="w-full p-2 border rounded"/></div>
            <div><label className="block text-xs font-semibold">Store ID</label>
              <input id="storeId" value={storeId} onChange={e=>setStoreId(e.target.value)} required className="w-full p-2 border rounded"/></div>
          </div>
          {SECTIONS.map(sec=>(
            <div key={sec.id} id={`${sec.id}-section`} className="mb-4 report-box p-2 fade-in">
              <h2 className="section-title">{sec.title}</h2>
              <table className="w-full border-collapse mt-1 mb-2">
                <thead>
                  <tr className="bg-gray-100">
                    <th className="border px-2 py-1 text-left text-xs font-bold">Question</th>
                    {sec.id==='TSA'
                      ? [10,5,0].map(val=><th key={val} className="border px-2 py-1 text-center text-xs">{val}</th>)
                      : options.map(([opt])=><th key={opt} className="border px-2 py-1 text-center text-xs uppercase">{opt}</th>)}
                  </tr>
                </thead>
                <tbody>
                  {sec.items.map(it=>{
                    const key=`${sec.id}_${it.id}`;
                    return (
                      <tr id={key} key={it.id} className="even:bg-gray-50 hover:bg-gray-50">
                        <td className="border px-2 py-1">{it.q}</td>
                        {sec.id==='TSA'
                          ? [10,5,0].map(val=>{
                              const sel=resp[key]===String(val);
                              return (
                                <td key={val} className="border px-2 py-1 text-center">
                                  <button
                                    type="button"
                                    onClick={()=>handleTSA(sec,it,String(val))}
                                    className={`${sel?'bg-blue-200 ring-2 ring-blue-500':'bg-gray-200'} hover:bg-blue-300 px-2 py-0.5 text-xs rounded-full transition`}
                                  >{val}</button>
                                </td>
                              );
                            })
                          : options.map(([opt,color])=>{
                              const sel=resp[key]===opt;
                              return (
                                <td key={opt} className="border px-2 py-1 text-center">
                                  <button
                                    type="button"
                                    onClick={()=>handleOption(sec,it,opt)}
                                    className={`${sel?`bg-${color}-200 ring-2 ring-${color}-500`:`bg-${color}-100`} hover:bg-${color}-300 px-2 py-0.5 text-xs rounded-full transition`}
                                  >{opt.toUpperCase()}</button>
                                </td>
                              );
                            })}
                      </tr>
                    );
                  })}
                </tbody>
              </table>
              <div className="mt-2 fade-in">
                <label className="block text-xs font-semibold">Upload Images</label>
                <input type="file" accept="image/*" capture="environment" multiple onChange={e=>addImages(sec,e)} className="mt-1"/>
                <div className="flex space-x-2 mt-2 overflow-x-auto">
                  {(imgs[sec.id]||[]).map((s,i)=><img key={i} src={s} className="w-16 h-16 object-cover rounded-md border"/>) }
                </div>
              </div>
            </div>
          ))}
          <div className="flex space-x-4 fade-in">
            <button type="button" onClick={resetAll} className="flex-1 bg-blue-100 py-3 rounded-full hover:bg-blue-200 transition">New Response</button>
            <button type="submit" className={`flex-1 bg-green-100 py-3 rounded-full hover:bg-green-200 transition ${downloading?'opacity-70 pointer-events-none':''}`}>
              {downloading?'Generating Report...':'Submit & Download PDF'}
            </button>
          </div>
        </form>
      );
    }
    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
