<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Training Audit | Third wave coffee</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
</head>
<body class="bg-gray-100">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const params = new URLSearchParams(window.location.search);
    const auditorName = params.get('auditorName')||params.get('name')||'';
    const auditorId   = params.get('auditorId')||params.get('id')||'';
    const LOG_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzlorpE-XN1Fkxdf156d84gWmpWUluBO8mrJWkxelG2L0AEdry0BXS1NM08CCJ7ZNYZ/exec';

    const safeVibrate = pattern => { if(navigator?.vibrate) navigator.vibrate(pattern); };
    const safeLS = { get:k=>{try{return localStorage.getItem(k)}catch{return null}}, set:(k,v)=>{try{localStorage.setItem(k,v)}catch{}}, clear:()=>{try{localStorage.clear()}catch{}} };
    const logEvent = (e,d={})=>{ fetch(LOG_ENDPOINT,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify({event:e,timestamp:new Date().toISOString(),...d})}); };

    const SECTIONS = [
      { id:'Training Materials', title:'Training Materials', items:[
        {id:'TM_1',q:'FRM available at store?',w:1},
        {id:'TM_2',q:'BRM available at store?',w:1},
        {id:'TM_3',q:'One-pager – Hot/Cue Cards displayed?',w:1},
        {id:'TM_4',q:'One-pager – Cold/Cue Cards displayed?',w:1},
        {id:'TM_5',q:'Dial-in One-pager visible?',w:2},
        {id:'TM_6',q:'New-launch learning material posted?',w:1},
        {id:'TM_7',q:'COFFEE & HD Playbook in store?',w:1},
        {id:'TM_8',q:'MSDS, chemical chart and Shelf life chart available?',w:1},
        {id:'TM_9',q:'Career Progression Chart & Reward Poster displayed?',w:1}
      ]},
      { id:'LMS', title:'LMS Usage', items:[
        {id:'LMS_1',q:'Orientation & Induction completed within 3 days of joining?',w:4},
        {id:'LMS_2',q:'All assessments & knowledge checks on LMS?',w:4},
        {id:'LMS_3',q:'Team uses LMS for new information & comms?',w:2}
      ]},
      { id:'Buddy', title:'Buddy Trainer Availability & Capability', items:[
        {id:'Buddy_1',q:'Does the café have at least 2 certified Buddy Trainers?',w:2},
        {id:'Buddy_2',q:'Have Buddy Trainers completed their Skill Check?',w:2},
        {id:'Buddy_3',q:'Are trainees rostered with Buddy Trainers and working in the same shift?',w:1},
        {id:'Buddy_4',q:'Have Buddy Trainers attended the BT workshop?',w:2},
        {id:'Buddy_5',q:'Can Buddy Trainers explain the 4-step training process effectively?',w:2},
        {id:'Buddy_6',q:'Can Buddy Trainers navigate Zing LMS flawlessly?',w:1}
      ]},
      { id:'NewJoiner', title:'New Joiner Training & Records', items:[
        {id:'NJ_1',q:'Is the OJT book available for all partners?',w:1},
        {id:'NJ_2',q:'Are trainees referring to the OJT book and completing their skill checks?',w:1},
        {id:'NJ_3',q:'Is training progression aligned with the Training Calendar/Plan?',w:1},
        {id:'NJ_4',q:'Are team members aware of post-barista training progressions?',w:1},
        {id:'NJ_5',q:'Have managers completed SHLP training as per the calendar?',w:2},
        {id:'NJ_6',q:'Are there at least 2 FOSTAC-certified managers in the store?',w:2},
        {id:'NJ_7',q:'Is ASM/SM training completed as per the Training Calendar?',w:2}
      ]},
      { id:'PartnerKnowledge', title:'Partner Knowledge', items:[
        {id:'PK_1',q:'Are team members aware of current company communications?',w:2},
        {id:'PK_2',q:'Ask a team member to conduct a Coffee Tasting & Sampling',w:2},
        {id:'PK_3',q:'Is Sampling being conducted as per the set guidelines?',w:2},
        {id:'PK_4',q:'Is Coffee Tasting engaging and effective?',w:2},
        {id:'PK_5',q:'Are team members aware of manual brewing methods and standards?',w:2},
        {id:'PK_6',q:'Are partners following grooming standards?',w:2},
        {id:'PK_7',q:'Ask questions about key topics: COFFEE, LTO, MSDS, Safety?',w:3}
      ]},
      { id:'TSA', title:'TSA - Training Skill Assessment', items:[
        {id:'TSA_1',q:'Partner 1 – Hot & Cold stations work?',w:10},
        {id:'TSA_2',q:'Partner 2 – Food station cleanliness?',w:10},
        {id:'TSA_3',q:'Partner 3 – Customer Service quality?',w:10}
      ]},
      { id:'CustomerExperience', title:'Customer Experience', items:[
        {id:'CX_1',q:'Is background music at appropriate volume?',w:1},
        {id:'CX_2',q:'Is store temperature comfortable?',w:1},
        {id:'CX_3',q:'Are washrooms clean & well-maintained?',w:1},
        {id:'CX_4',q:'Is Wi-Fi available & functioning?',w:1},
        {id:'CX_5',q:'Are marketing & VM displays correct?',w:2},
        {id:'CX_6',q:'Is store furniture clean & well-kept?',w:1},
        {id:'CX_7',q:'What do you understand by MA, CPI, QA scores?',w:1},
        {id:'CX_8',q:'What was the latest Mystery Audit score for the store?',w:1},
        {id:'CX_9',q:'Top 2 CX opportunity areas last month?',w:1}
      ]},
      { id:'ActionPlan', title:'Action Plan & Continuous Improvement', items:[
        {id:'AP_1',q:'Have concerns been addressed within 48hrs of audit?',w:1},
        {id:'AP_2',q:'Are action plan points closed or in progress?',w:2},
        {id:'AP_3',q:'Are all managers aware of the action plan?',w:2}
      ]}
    ];
    const optionColors = { yes:'green', no:'red', na:'yellow' };
    const options = Object.entries(optionColors);

    function App(){
      const [resp,setResp] = useState(()=>JSON.parse(safeLS.get('resp')||'{}'));
      const [storeName,setStoreName] = useState(safeLS.get('storeName')||'');
      const [storeId,setStoreId] = useState(safeLS.get('storeId')||'');
      const [imgs,setImgs] = useState(()=>JSON.parse(safeLS.get('imgs')||'{}'));

      useEffect(()=>{logEvent('PageLoaded',{auditorName,auditorId,storeName,storeId});},[]);
      useEffect(()=>{const save=()=>{safeLS.set('resp',JSON.stringify(resp));safeLS.set('storeName',storeName);safeLS.set('storeId',storeId);safeLS.set('imgs',JSON.stringify(imgs));};window.addEventListener('beforeunload',save);return()=>window.removeEventListener('beforeunload',save);},[resp,storeName,storeId,imgs]);

      const handleOption = (sec,it,val) => {
        const key = `${sec}_${it}`;
        setResp(prev=>({...prev,[key]:val}));
        logEvent('change',{key,val});
        // Haptics: yes=1, no=2, na=0
        if(navigator?.vibrate){
          if(val==='yes') safeVibrate(50);
          else if(val==='no') safeVibrate([50,100,50]);
        }
      };
      const handleTSA = (sec,it,val) => {
        const key = `${sec}_${it}`;
        setResp(prev=>({...prev,[key]:val}));
        logEvent('change',{key,val});
        // no vibration for TSA options
      };
      const addImages=(sec,e)=>{Array.from(e.target.files).forEach(f=>{EXIF.getData(f,function(){const r=new FileReader();r.onload=ev=>setImgs(p=>({...p,[sec]:[...(p[sec]||[]),ev.target.result]}));r.readAsDataURL(f);});});e.target.value=null;};
      const scrollTo=(id)=>{const el=document.getElementById(id);if(el)el.scrollIntoView({behavior:'smooth',block:'center'});};

      const handleSubmit=e=>{
        e.preventDefault();
        // validate header
        if(!storeName.trim()){safeVibrate(200);scrollTo('storeName');return;}
        if(!storeId.trim()){safeVibrate(200);scrollTo('storeId');return;}
        // validate questions
        for(const sec of SECTIONS){for(const it of sec.items){const key=`${sec.id}_${it.id}`;if(resp[key]==null){safeVibrate(200);scrollTo(key);return;}}}
        safeVibrate(100);
      };
      const resetAll=()=>{safeLS.clear();setResp({});setStoreName('');setStoreId('');setImgs({});safeVibrate([200]);};

      return(
        <form onSubmit={handleSubmit} className="space-y-6 p-6 bg-white rounded-lg shadow">
          <h1 className="text-2xl font-bold text-center">Training Audit | Third wave coffee</h1>
          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
            <div><label className="block text-sm">Auditor Name</label><input id="auditorName" readOnly value={auditorName} className="w-full p-2 border rounded bg-gray-100"/></div>
            <div><label className="block text-sm">Auditor ID</label><input id="auditorId" readOnly value={auditorId} className="w-full p-2 border rounded bg-gray-100"/></div>
            <div><label htmlFor="storeName" className="block text-sm">Store Name</label><input id="storeName" value={storeName} onChange={e=>setStoreName(e.target.value)} className="w-full p-2 border rounded"/></div>
            <div><label htmlFor="storeId" className="block text-sm">Store ID</label><input id="storeId" value={storeId} onChange={e=>setStoreId(e.target.value)} className="w-full p-2 border rounded"/></div>
          </div>
          {SECTIONS.map(sec=>(
            <div key={sec.id} className="mb-6" id={`${sec.id}-section`}>
              <div className="px-4 py-2 border-b"><h2 className="text-lg font-semibold">{sec.title}</h2></div>
              <div className="p-4 overflow-x-auto">
                <table className="min-w-full border-collapse">
                  <thead><tr className="bg-gray-100"><th className="border px-4 py-3 text-left whitespace-nowrap">Question</th>
                    {sec.id==='TSA'
                      ? [10,5,0].map(val=><th key={val} className="border px-2 py-1 text-center text-xs">{val}</th>)
                      : options.map(([opt])=><th key={opt} className="border px-2 py-1 text-center text-xs uppercase">{opt}</th>)}
                  </tr></thead>
                  <tbody>
                    {sec.items.map(it=>{
                      const key=`${sec.id}_${it.id}`;
                      return(
                        <tr id={key} key={it.id} className="even:bg-gray-50 hover:bg-gray-50">
                          <td className="border px-4 py-3 whitespace-nowrap">{it.q}</td>
                          {sec.id==='TSA'
                            ? [10,5,0].map(val=>{ const sel=resp[key]===String(val); return (<td key={val} className="border px-2 py-1 text-center"><button type="button" onClick={()=>handleTSA(sec.id,it.id,String(val))} className={`${sel?'bg-blue-200 ring-2 ring-blue-500':'bg-gray-200'} hover:bg-blue-300 px-2 py-0.5 text-xs rounded-full transition`}>{val}</button></td>); })
                            : options.map(([opt,color])=>{ const sel=resp[key]===opt; return (<td key={opt} className="border px-2 py-1 text-center"><button type="button" onClick={()=>handleOption(sec.id,it.id,opt)} className={`${sel?`bg-${color}-200 ring-2 ring-${color}-500`:`bg-${color}-100`} hover:bg-${color}-300 px-2 py-0.5 text-xs rounded-full transition`}>{opt.toUpperCase()}</button></td>); })}
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
                <div className="mt-4"><label className="block text-sm">Upload Images</label><input type="file" accept="image/*" capture="environment" multiple onChange={e=>addImages(sec.id,e)} className="mt-1"/><div className="flex space-x-2 mt-2 overflow-x-auto">{(imgs[sec.id]||[]).map((s,i)=><img key={i} src={s} className="w-16 h-16 object-cover rounded-md border"/>)} </div></div>
              </div>
            </div>
          ))}
          <div className="flex space-x-4"><button type="button" onClick={resetAll} className="flex-1 bg-blue-100 py-3 rounded-full hover:bg-blue-200">New Response</button><button type="submit" className="flex-1 bg-green-100 py-3 rounded-full hover:bg-green-200">Submit & Download PDF</button></div>
        </form>
      );
    }
    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
