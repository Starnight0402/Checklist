<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Training Audit | Third wave coffee</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
  <style>
    body { background: #f7fafc; }
    .report-section-box { border-radius: 18px; background: #f7f8fc; box-shadow: 0 1px 7px 0 rgba(0,0,0,0.04); border: 1.5px solid #e7eaf1; margin-bottom: 18px; }
    .pdf-section { borderRadius: 14, fillColor: [245,247,252], lineWidth: 0.8, lineColor: [195,205,222] }
    .pdf-header { fontSize: 18, fontStyle: 'bold', textColor: [45,55,72] }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    // --- URL PARAM PULL ---
    const params = new URLSearchParams(window.location.search);
    const auditorName = params.get('name')||'';
    const auditorId   = params.get('id')||'';
    // --- SECTION DEFINITION ---
    const SECTIONS = [
      { id:'TrainingMaterials', title:'Training Materials', items:[
        {id:'TM_1',q:'FRM available at store?',w:1},
        {id:'TM_2',q:'BRM available at store?',w:1},
        {id:'TM_3',q:'One-pager – Hot/Cue Cards displayed?',w:1},
        {id:'TM_4',q:'One-pager – Cold/Cue Cards displayed?',w:1},
        {id:'TM_5',q:'Dial-in One-pager visible?',w:2},
        {id:'TM_6',q:'New-launch learning material posted?',w:1},
        {id:'TM_7',q:'COFFEE & HD Playbook in store?',w:1},
        {id:'TM_8',q:'MSDS & Shelf life chart displayed?',w:1},
        {id:'TM_9',q:'Career Progression Chart & Reward Poster displayed?',w:1}
      ]},
      { id:'LMS', title:'LMS Usage', items:[
        {id:'LMS_1',q:'Orientation & Induction completed within 3 days of joining?',w:4, wneg:-4},
        {id:'LMS_2',q:'All assessments & knowledge checks on LMS?',w:4, wneg:-4},
        {id:'LMS_3',q:'Team uses LMS for new info & comms?',w:2}
      ]},
      { id:'Buddy', title:'Buddy Trainer Availability & Capability', items:[
        {id:'Buddy_1',q:'≥2 certified Buddy Trainers?',w:2},
        {id:'Buddy_2',q:'Buddy Trainers passed skill checks?',w:2},
        {id:'Buddy_3',q:'Trainees rostered with Buddies?',w:1},
        {id:'Buddy_4',q:'Buddy Trainers attended workshop?',w:2},
        {id:'Buddy_5',q:'Explain 4-step training process?',w:2},
        {id:'Buddy_6',q:'Navigate LMS flawlessly?',w:1}
      ]},
      { id:'NewJoiner', title:'New Joiner Training & Records', items:[
        {id:'NJ_1',q:'OJT book available for all partners?',w:1},
        {id:'NJ_2',q:'Trainees completing skill checks?',w:1},
        {id:'NJ_3',q:'Training aligned with plan?',w:1},
        {id:'NJ_4',q:'Aware of progressions?',w:1},
        {id:'NJ_5',q:'Managers completed SHLP training?',w:2},
        {id:'NJ_6',q:'≥2 FOSTAC-certified managers?',w:2},
        {id:'NJ_7',q:'ASM/SM training completed?',w:2}
      ]},
      { id:'PartnerKnowledge', title:'Partner Knowledge', items:[
        {id:'PK_1',q:'Aware of company communications?',w:2},
        {id:'PK_2',q:'Conduct Coffee Tasting & Sampling?',w:2},
        {id:'PK_3',q:'Sampling per guidelines?',w:2},
        {id:'PK_4',q:'Tasting engaging?',w:2},
        {id:'PK_5',q:'Aware of manual brew standards?',w:2},
        {id:'PK_6',q:'Partners follow grooming standards?',w:2},
        {id:'PK_7',q:'Pop-quiz key topics passed?',w:3, wneg:-3}
      ]},
      { id:'TSA', title:'TSA - Training Skill Assessment', items:[
        {id:'TSA_1',q:'Hot & Cold stations work?',w:10},
        {id:'TSA_2',q:'Food station cleanliness?',w:10},
        {id:'TSA_3',q:'Customer Service quality?',w:10}
      ]},
      { id:'CustomerExperience', title:'Customer Experience', items:[
        {id:'CX_1',q:'Music at proper volume?',w:1},
        {id:'CX_2',q:'Temperature comfortable?',w:1},
        {id:'CX_3',q:'Washrooms clean?',w:1},
        {id:'CX_4',q:'Wi-Fi working?',w:1},
        {id:'CX_5',q:'VM displays correct?',w:2},
        {id:'CX_6',q:'Furniture well-kept?',w:1},
        {id:'CX_7',q:'Understanding MA/CPI/QA?',w:1},
        {id:'CX_8',q:'Latest Mystery Audit score?',w:1},
        {id:'CX_9',q:'Top 2 CX opps last month?',w:1}
      ]},
      { id:'ActionPlan', title:'Action Plan & Continuous Improvement', items:[
        {id:'AP_1',q:'Concerns addressed within 48hrs?',w:1, wneg:-1},
        {id:'AP_2',q:'Action points closed/work-in-progress?',w:2},
        {id:'AP_3',q:'Managers aware of action plan?',w:2}
      ]}
    ];
    // Button and scoring config
    const optionColors = { yes:'green', no:'red', na:'yellow' };
    const options = Object.entries(optionColors);

    // --- COMPONENT ---
    function App(){
      const [resp,setResp]=useState({});
      const [storeName,setStoreName]=useState('');
      const [storeId,setStoreId]=useState('');
      const [imgs,setImgs]=useState({});
      // For mobile: always scroll to missing field on submit
      const scrollTo=(id)=>{const el=document.getElementById(id);if(el)el.scrollIntoView({behavior:'smooth',block:'center'});};
      // Haptics
      const safeVibrate=pat=>{try{if(navigator?.vibrate)vibrate(pat);}catch{}};
      const vibrate=pat=>navigator.vibrate(pat);
      // Option change handlers
      const handleOption=(sec,it,val)=>{
        const key=sec.id+'_'+it.id; setResp(p=>({...p,[key]:val}));
        if(val==='yes')safeVibrate(50); else if(val==='no')safeVibrate([50,100]); // yes: zap, no: double zap
      };
      const handleTSA=(sec,it,val)=>{
        const key=sec.id+'_'+it.id; setResp(p=>({...p,[key]:val}));
      };
      // Image upload
      const addImages=(sec,e)=>{Array.from(e.target.files).forEach(f=>{
        EXIF.getData(f,function(){
          const r=new FileReader();
          r.onload=ev=>setImgs(p=>({...p,[sec.id]:[...(p[sec.id]||[]),ev.target.result]}));
          r.readAsDataURL(f);
        });});
        e.target.value=null;
      };
      // Submit + validation + PDF
      const handleSubmit=e=>{
        e.preventDefault();
        if(!storeName.trim()){safeVibrate([200,200]);scrollTo('storeName');return;}
        if(!storeId.trim()){safeVibrate([200,200]);scrollTo('storeId');return;}
        for(const sec of SECTIONS)for(const it of sec.items){
          const key=sec.id+'_'+it.id;
          if(resp[key]==null){safeVibrate([200,200]);scrollTo(key);return;}
        }
        // SCORING
        let total=0, max=0;
        SECTIONS.forEach(sec=>sec.items.forEach(it=>{
          const key=sec.id+'_'+it.id, r=resp[key];
          if(sec.id==='TSA'){const v=parseInt(r)||0; total+=v; max+=it.w;}
          else{
            if(r==='yes')total+=it.w;
            else if(r==='no'&&it.wneg)total+=it.wneg;
            if(r!=='na')max+=Math.abs(it.w);
          }
        }));
        const pct = max?Math.round((total/max)*100):0;
        // PDF EXPORT --->
        const {jsPDF}=window.jspdf;
        const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
        // Title and credentials
        doc.setFontSize(20);doc.setTextColor(41,53,72);
        doc.text('Training Audit | Third wave coffee', 105, 18, {align:'center'});
        doc.setFontSize(12);doc.setTextColor(41,53,72);
        doc.text(`Auditor: ${auditorName||'-'} (ID: ${auditorId||'-'})`, 15, 28);
        doc.text(`Store: ${storeName||'-'} (ID: ${storeId||'-'})`, 15, 35);
        doc.setFontSize(13);doc.setTextColor(28,37,56);doc.text(`Overall Score: ${total}/${max}    Percentage: ${pct}%`, 15, 43);
        let y = 48;
        // --- Section rendering
        SECTIONS.forEach(sec=>{
          // --- Calculate section score
          let secTotal=0, secMax=0;
          sec.items.forEach(it=>{
            const key=sec.id+'_'+it.id, r=resp[key];
            if(sec.id==='TSA'){const v=parseInt(r)||0; secTotal+=v; secMax+=it.w;}
            else{if(r==='yes')secTotal+=it.w; else if(r==='no'&&it.wneg)secTotal+=it.wneg;if(r!=='na')secMax+=Math.abs(it.w);}
          });
          // --- Box layout vars
          const boxX=12, boxW=186, innerPad=4;
          let boxStartY=y, headingY=y+10;
          // Draw box (soft color)
          doc.setFillColor(245,247,252); // pastel lavender/blue
          doc.setDrawColor(195,205,222);
          doc.roundedRect(boxX, boxStartY, boxW, 10+6*sec.items.length+innerPad*2+8, 5, 5, 'F');
          // Section heading
          doc.setFontSize(13);doc.setTextColor(36,39,48);doc.setFont('helvetica','bold');
          doc.text(`${sec.title}   (Section Score: ${secTotal}/${secMax})`, boxX+boxW/2, headingY, {align:'center'});
          // Table header
          doc.setFontSize(11); doc.setTextColor(60,63,74); doc.setFont('helvetica','normal');
          const tableY=headingY+4;
          doc.text('Question', boxX+5, tableY);
          doc.text('Response', boxX+110, tableY);
          doc.text('Score', boxX+162, tableY);
          // Table rows
          let rowY = tableY+6;
          sec.items.forEach(it=>{
            const key=sec.id+'_'+it.id, r=resp[key];
            const displayResp = sec.id==='TSA' ? (r||'0') : (typeof r==='string'?r.toUpperCase():r);
            const score = sec.id==='TSA' ? (parseInt(r)||0) : (r==='yes'?it.w:(r==='no'&&it.wneg?it.wneg:0));
            doc.setFontSize(10); doc.setTextColor(50,50,50); doc.setFont('helvetica','normal');
            doc.text(it.q, boxX+5, rowY, {maxWidth:100});
            doc.text(String(displayResp), boxX+112, rowY);
            doc.text(String(score), boxX+162, rowY);
            rowY += 6;
          });
          // Images for section
          if((imgs[sec.id]||[]).length){
            rowY += 2;
            (imgs[sec.id]||[]).forEach((src,i)=>{
              if(rowY > 275){doc.addPage(); rowY=20;}
              doc.addImage(src, 'JPEG', boxX+8+38*i, rowY, 30, 30);
            });
            rowY += 34;
          }
          y = Math.max(rowY+innerPad, y+10+6*sec.items.length+innerPad*2+8);
          // If next section box will overflow, go to next page
          if(y+36>285){doc.addPage(); y=18;}
        });
        doc.save(`audit_${storeName||'audit'}_${Date.now()}.pdf`);
      };

      // ---- Form rendering ----
      return (
        <form onSubmit={handleSubmit} className="max-w-3xl mx-auto p-2">
          <h1 className="text-2xl font-bold text-center mb-4">Training Audit | Third wave coffee</h1>
          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-5">
            <div>
              <label className="block text-sm">Auditor Name</label>
              <input id="auditorName" readOnly value={auditorName} className="w-full p-2 border rounded bg-gray-100"/>
            </div>
            <div>
              <label className="block text-sm">Auditor ID</label>
              <input id="auditorId" readOnly value={auditorId} className="w-full p-2 border rounded bg-gray-100"/>
            </div>
            <div>
              <label htmlFor="storeName" className="block text-sm">Store Name</label>
              <input id="storeName" value={storeName} onChange={e=>setStoreName(e.target.value)} className="w-full p-2 border rounded"/>
            </div>
            <div>
              <label htmlFor="storeId" className="block text-sm">Store ID</label>
              <input id="storeId" value={storeId} onChange={e=>setStoreId(e.target.value)} className="w-full p-2 border rounded"/>
            </div>
          </div>
          {SECTIONS.map(sec=>(
            <div key={sec.id} className="report-section-box p-3 mb-4">
              <h2 className="text-lg font-semibold mb-2 text-center">{sec.title}</h2>
              <table className="w-full border-collapse text-sm">
                <thead>
                  <tr className="bg-gray-100">
                    <th className="border px-2 py-1 text-left">Question</th>
                    {sec.id==='TSA'
                      ? [10,5,0].map(val=><th key={val} className="border px-2 py-1 text-center text-xs">{val}</th>)
                      : options.map(([opt])=><th key={opt} className="border px-2 py-1 text-center text-xs uppercase">{opt}</th>)}
                  </tr>
                </thead>
                <tbody>
                  {sec.items.map(it=>{
                    const key=sec.id+'_'+it.id;
                    return (
                      <tr id={key} key={it.id} className="even:bg-gray-50 hover:bg-gray-50">
                        <td className="border px-2 py-1">{it.q}</td>
                        {sec.id==='TSA'
                          ? [10,5,0].map(val=>{
                              const sel=resp[key]===String(val);
                              return (
                                <td key={val} className="border px-2 py-1 text-center">
                                  <button
                                    type="button"
                                    onClick={()=>handleTSA(sec,it,String(val))}
                                    className={`${sel?'bg-blue-200 ring-2 ring-blue-500':'bg-gray-200'} hover:bg-blue-300 px-2 py-0.5 text-xs rounded-full transition`}
                                  >{val}</button>
                                </td>
                              );
                            })
                          : options.map(([opt,color])=>{
                              const sel=resp[key]===opt;
                              return (
                                <td key={opt} className="border px-2 py-1 text-center">
                                  <button
                                    type="button"
                                    onClick={()=>handleOption(sec,it,opt)}
                                    className={`${sel?`bg-${color}-200 ring-2 ring-${color}-500`:`bg-${color}-100`} hover:bg-${color}-300 px-2 py-0.5 text-xs rounded-full transition`}
                                  >{opt.toUpperCase()}</button>
                                </td>
                              );
                            })}
                      </tr>
                    );
                  })}
                </tbody>
              </table>
              <div className="mt-2">
                <label className="block text-xs font-medium mb-1">Upload Images</label>
                <input type="file" accept="image/*" capture="environment" multiple onChange={e=>addImages(sec,e)} className="mt-1"/>
                <div className="flex space-x-2 mt-2 overflow-x-auto">
                  {(imgs[sec.id]||[]).map((s,i)=><img key={i} src={s} className="w-12 h-12 object-cover rounded-md border"/>) }
                </div>
              </div>
            </div>
          ))}
          <div className="flex space-x-4 mt-5">
            <button type="button" onClick={()=>{setResp({});setStoreName('');setStoreId('');setImgs({});safeVibrate([120,120]);}} className="flex-1 bg-blue-100 py-3 rounded-full hover:bg-blue-200 transition">New Response</button>
            <button type="submit" className="flex-1 bg-green-100 py-3 rounded-full hover:bg-green-200 transition">Submit & Download PDF</button>
          </div>
        </form>
      );
    }
    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
