<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Third Wave Coffee | Training Audit</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React + ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <!-- jsPDF + autoTable plugin -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    body { background: #f3f4f6; font-family: sans-serif; margin: 0; }
    .container { max-width: 800px; margin: 2rem auto; background: white; padding: 1rem; border-radius: 0.5rem; }
    .title { text-align: center; font-size: 1.75rem; font-weight: 700; margin-bottom: 1rem; }
    .grid { display: grid; gap: 1rem; }
    .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
    table { border-collapse: collapse; width: 100%; margin-bottom: 1rem; }
    th, td { border: 1px solid #e5e7eb; padding: 0.5rem; }
    th { background-color: #e5e7eb; }
    input[type="radio"] { margin-right: 0.25rem; }
    input[type="file"] { margin-top: 0.5rem; }
    .section { margin-bottom: 2rem; }
    .section h2 { margin-bottom: 0.5rem; font-weight: 600; }
    .submit-btn { background: #4f46e5; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.375rem; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container" id="root"></div>

  <script>
    // Checklist data
    window.CHECKLIST = {
      "name":"Training Audit Checklist","version":"1.0",
      "sections":[ /* full sections JSON as before */
        {"id":"Training Materials","title":"Training Materials","items":[
          {"id":"TM_1","question":"FRM available at store?","weight":1},
          {"id":"TM_2","question":"BRM available at store?","weight":1},
          {"id":"TM_3","question":"One-pager – Hot/Cue Cards displayed?","weight":1},
          {"id":"TM_4","question":"One-pager – Cold/Cue Cards displayed?","weight":1},
          {"id":"TM_5","question":"Dial-in One-pager visible?","weight":2},
          {"id":"TM_6","question":"New-launch learning material posted?","weight":1},
          {"id":"TM_7","question":"COFFEE Playbook in store?","weight":1},
          {"id":"TM_8","question":"Shelf-life chart displayed?","weight":1},
          {"id":"TM_9","question":"Career progression chart displayed?","weight":1}
        ]},
        {"id":"LMS","title":"LMS Usage","items":[
          {"id":"LMS_1","question":"Orientation & Induction completed within 3 days?","weight":4},
          {"id":"LMS_2","question":"All assessments & knowledge checks on LMS?","weight":4},
          {"id":"LMS_3","question":"Team uses LMS for new info & comms?","weight":2}
        ]},
        {"id":"Buddy","title":"Buddy Trainer Capabilities","items":[
          {"id":"Buddy_1","question":"≥2 certified Buddy Trainers in café?","weight":2},
          {"id":"Buddy_2","question":"Buddy Trainers passed skill checks?","weight":2},
          {"id":"Buddy_3","question":"Trainees rostered with Buddies?","weight":2},
          {"id":"Buddy_4","question":"Logbook up-to-date?","weight":1},
          {"id":"Buddy_5","question":"Badge worn during training?","weight":1},
          {"id":"Buddy_6","question":"Schedules visible?","weight":1},
          {"id":"Buddy_7","question":"Monthly feedback sessions?","weight":1}
        ]},
        {"id":"NewJoiner","title":"New Joiner Training","items":[
          {"id":"NJ_1","question":"Tracker updated?","weight":2},
          {"id":"NJ_2","question":"15-day cert completed?","weight":2},
          {"id":"NJ_3","question":"Skill gaps documented?","weight":1},
          {"id":"NJ_4","question":"Training wall current?","weight":1},
          {"id":"NJ_5","question":"Learning plan filed?","weight":1},
          {"id":"NJ_6","question":"Cert cards issued?","weight":1},
          {"id":"NJ_7","question":"Refresher logged?","weight":1}
        ]},
        {"id":"Partner","title":"Partner Knowledge","items":[
          {"id":"PK_1","question":"Team knows company comms?","weight":1},
          {"id":"PK_2","question":"Tasting & sampling done?","weight":1},
          {"id":"PK_3","question":"Sampling follows guidelines?","weight":1},
          {"id":"PK_4","question":"Tasting engaging?","weight":1},
          {"id":"PK_5","question":"Team knows manual brew?","weight":1},
          {"id":"PK_6","question":"Grooming standards met?","weight":1},
          {"id":"PK_7","question":"Pop-quiz passed?","weight":1}
        ]},
        {"id":"TSA","title":"Skill Assessment","items":[
          {"id":"TSA_1","question":"Hot & Cold stations working?","weight":1},
          {"id":"TSA_2","question":"Food station cleanliness?","weight":1},
          {"id":"TSA_3","question":"Customer Service quality?","weight":1}
        ]},
        {"id":"CX","title":"Customer Experience","items":[
          {"id":"CX_1","question":"Music at right volume?","weight":1},
          {"id":"CX_2","question":"Temperature comfortable?","weight":1},
          {"id":"CX_3","question":"Washrooms clean?","weight":1},
          {"id":"CX_4","question":"Wi-Fi working?","weight":1},
          {"id":"CX_5","question":"VM elements correct?","weight":1},
          {"id":"CX_6","question":"Furniture well-kept?","weight":1},
          {"id":"CX_7","question":"Staff know key metrics?","weight":1},
          {"id":"CX_8","question":"Mystery Audit score known?","weight":1},
          {"id":"CX_9","question":"Top 2 CX opps named?","weight":1}
        ]},
        {"id":"AP","title":"Action Plan","items":[
          {"id":"AP_1","question":"Concerns addressed?","weight":2},
          {"id":"AP_2","question":"Managers aware?","weight":3}
        ]}
      ]
    };

    // React application
    const { useState, useEffect } = React;
    const params = new URLSearchParams(location.search);
    const auditor = { name: params.get("name")||"", id: params.get("id")||"" };
    const KEY = `audit_${auditor.id}`;
    const LOG_ENDPOINT = "https://script.google.com/macros/s/AKfycby_IJdm8W5aKaL-lcm5Gd_aFWwyHPQ7Sz9IE8VDFLH2OWaX8pj9i2N_nnRVwjqqlTSB/exec";

    function freshResponses() {
      const obj = {};
      window.CHECKLIST.sections.forEach(sec => sec.items.forEach(it => obj[it.id] = { score: null, na: false }));
      return obj;
    }

    function App() {
      const [resp, setResp] = useState(() => {
        try { return JSON.parse(localStorage.getItem(KEY)) || freshResponses(); } catch { return freshResponses(); }
      });
      const [storeName, setStoreName] = useState("");
      const [storeId, setStoreId] = useState("");

      useEffect(() => { localStorage.setItem(KEY, JSON.stringify(resp)); }, [resp]);
      const upd = (id, patch) => setResp(r => ({ ...r, [id]: { ...r[id], ...patch } }));

      const handleSubmit = e => {
        e.preventDefault();
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Header gradient + dynamic title
        doc.setFillColor(79,70,229);
        doc.rect(0, 0, doc.internal.pageSize.getWidth(), 25, 'F');
        doc.setTextColor(255,255,255);
        doc.setFontSize(18);
        doc.text(`Training audit report | ${storeName}`, doc.internal.pageSize.getWidth()/2, 15, { align: "center" });

        // Details table
        const details = [
          { field: 'Store Name', value: storeName },
          { field: 'Store ID', value: storeId },
          { field: 'Auditor Name', value: auditor.name },
          { field: 'Auditor ID', value: auditor.id }
        ];
        let totalScore = 0, maxScore = 0;
        const rows = [];
        window.CHECKLIST.sections.forEach(sec => sec.items.forEach(it => {
          const r = resp[it.id];
          const ans = r.na ? 'NA' : (r.score === it.weight ? 'Yes' : 'No');
          rows.push([sec.title, it.question, ans]);
          if (!r.na && r.score != null) { totalScore += r.score; maxScore += it.weight; }
        }));
        const percentage = maxScore ? Math.round(100 * totalScore / maxScore) : 0;
        details.push({ field: 'Score', value: `${totalScore}/${maxScore}` });
        details.push({ field: 'Percentage', value: `${percentage}%` });

        doc.autoTable({
          startY: 30,
          theme: 'grid',
          head: [['Field','Value']],
          body: details.map(d => [d.field, d.value]),
          styles: { fontSize: 10 },
          headStyles: { fillColor: [230,230,230], textColor: 0 }
        });
        const endY = doc.lastAutoTable.finalY + 5;

        // Main responses table with colored answers and correct didParseCell
        doc.autoTable({
          startY: endY,
          head: [['Section','Question','Response']],
          body: rows,
          styles: { fontSize: 8 },
          headStyles: { fillColor: [79,70,229], textColor: 255 },
          didParseCell: function(data) {
            if (data.section === 'body' && data.column.index === 2) {
              const txt = data.cell.text[0];
              if (txt === 'Yes') data.cell.styles.textColor = [0,128,0];
              if (txt === 'No') data.cell.styles.textColor = [255,0,0];
              if (txt === 'NA') data.cell.styles.textColor = [255,165,0];
            }
          }
        });

        // Log and save
        fetch(LOG_ENDPOINT, {
          method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ storeName, storeId, auditorName: auditor.name, auditorId: auditor.id, score: totalScore, percentage })
        });
        doc.save(`TWC_Audit_${auditor.id}_${Date.now()}.pdf`);
        localStorage.removeItem(KEY);
      };

      return React.createElement(
        'div', { className: 'container' },
        React.createElement('h1', { className: 'title' }, window.CHECKLIST.name),
        React.createElement('form', { onSubmit: handleSubmit },
          React.createElement('div', { className: 'grid grid-cols-2 mb-4' },
            React.createElement('div', null,
              React.createElement('label', { className: 'block font-medium mb-1' }, 'Auditor Name'),
              React.createElement('input', { type: 'text', value: auditor.name, readOnly: true, className: 'w-full p-2 border rounded' })
            ),
            React.createElement('div', null,
              React.createElement('label', { className: 'block font-medium mb-1' }, 'Auditor ID'),
              React.createElement('input', { type: 'text', value: auditor.id, readOnly: true, className: 'w-full p-2 border rounded' })
            )
          ),
          React.createElement('div', { className: 'grid grid-cols-2 mb-6' },
            React.createElement('div', null,
              React.createElement('label', { className: 'block font-medium mb-1' }, 'Store Name'),
              React.createElement('input', { type: 'text', value: storeName, onChange: e => setStoreName(e.target.value), required: true, className: 'w-full p-2 border rounded' })
            ),
            React.createElement('div', null,
              React.createElement('label', { className: 'block font-medium mb-1' }, 'Store ID'),
              React.createElement('input', { type: 'text', value: storeId, onChange: e => setStoreId(e.target.value), required: true, className: 'w-full p-2 border rounded' })
            )
          ),
          window.CHECKLIST.sections.map(sec => React.createElement(
            'div', { key: sec.id, className: 'section' },
            React.createElement('h2', null, sec.title),
            React.createElement('table', null,
              React.createElement('thead', null,
                React.createElement('tr', null,
                  React.createElement('th', null, 'Question'),
                  React.createElement('th', null, 'Yes'),
                  React.createElement('th', null, 'No'),
                  React.createElement('th', null, 'NA')
                )
              ),
              React.createElement('tbody', null,
                sec.items.map(it => {
                  const r = resp[it.id];
                  return React.createElement('tr', { key: it.id },
                    React.createElement('td', null, it.question),
                    React.createElement('td', { className: 'text-center' }, React.createElement('input', { type: 'radio', name: it.id, value: 'yes', required: true, checked: r.score === it.weight, onChange: () => upd(it.id, { score: it.weight, na: false }) })),
                    React.createElement('td', { className: 'text-center' }, React.createElement('input', { type: 'radio', name: it.id, value: 'no', checked: r.score === 0 && !r.na, onChange: () => upd(it.id, { score: 0, na: false }) })),
                    React.createElement('td', { className: 'text-center' }, React.createElement('input', { type: 'radio', name: it.id, value: 'na', checked: r.na, onChange: () => upd(it.id, { na: true, score: null }) }))
                  );
                })
              )
            ),
            React.createElement('input', { type: 'file', accept: 'image/*', multiple: true })
          )),
          React.createElement('button', { type: 'submit', className: 'submit-btn' }, 'Submit & Download PDF')
        )
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
  </script>
</body>
</html>
