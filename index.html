<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Training Audit Checklist</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-50 p-6">
  <div id="root" class="max-w-full mx-auto bg-white shadow-xl rounded-xl p-6"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const CHECKLIST = { sections: [
      { id: 'Training Materials', title: 'Training Materials', items: [
        { id: 'TM_1', q: 'FRM available at store?', w: 1 },
        { id: 'TM_2', q: 'BRM available at store?', w: 1 },
        { id: 'TM_3', q: 'One-pager – Hot/Cue Cards displayed?', w: 1 },
        { id: 'TM_4', q: 'One-pager – Cold/Cue Cards displayed?', w: 1 },
        { id: 'TM_5', q: 'Dial-in One-pager visible?', w: 2 },
        { id: 'TM_6', q: 'New-launch learning material posted?', w: 1 },
        { id: 'TM_7', q: 'COFFEE Playbook in store?', w: 1 },
        { id: 'TM_8', q: 'Shelf-life chart displayed?', w: 1 },
        { id: 'TM_9', q: 'Career progression chart displayed?', w: 1 }
      ]},
      { id: 'LMS', title: 'LMS Usage', items: [
        { id: 'LMS_1', q: 'Orientation & Induction completed within 3 days?', w: 4 },
        { id: 'LMS_2', q: 'All assessments & knowledge checks on LMS?', w: 4 },
        { id: 'LMS_3', q: 'Team uses LMS for new info & comms?', w: 2 }
      ]},
      { id: 'Buddy', title: 'Buddy Trainer Capabilities', items: [
        { id: 'Buddy_1', q: '≥2 certified Buddy Trainers in café?', w: 2 },
        { id: 'Buddy_2', q: 'Buddy Trainers passed skill checks?', w: 2 },
        { id: 'Buddy_3', q: 'Trainees rostered with Buddies?', w: 2 },
        { id: 'Buddy_4', q: 'Logbook up-to-date?', w: 1 },
        { id: 'Buddy_5', q: 'Badge worn during training?', w: 1 },
        { id: 'Buddy_6', q: 'Schedules visible?', w: 1 },
        { id: 'Buddy_7', q: 'Monthly feedback sessions?', w: 1 }
      ]},
      { id: 'NewJoiner', title: 'New Joiner Training', items: [
        { id: 'NJ_1', q: 'Tracker updated?', w: 2 },
        { id: 'NJ_2', q: '15-day cert completed?', w: 2 },
        { id: 'NJ_3', q: 'Skill gaps documented?', w: 1 },
        { id: 'NJ_4', q: 'Training wall current?', w: 1 },
        { id: 'NJ_5', q: 'Learning plan filed?', w: 1 },
        { id: 'NJ_6', q: 'Cert cards issued?', w: 1 },
        { id: 'NJ_7', q: 'Refresher logged?', w: 1 }
      ]},
      { id: 'Partner', title: 'Partner Knowledge', items: [
        { id: 'PK_1', q: 'Team knows company comms?', w: 1 },
        { id: 'PK_2', q: 'Tasting & sampling done?', w: 1 },
        { id: 'PK_3', q: 'Sampling follows guidelines?', w: 1 },
        { id: 'PK_4', q: 'Tasting engaging?', w: 1 },
        { id: 'PK_5', q: 'Team knows manual brew?', w: 1 },
        { id: 'PK_6', q: 'Grooming standards met?', w: 1 },
        { id: 'PK_7', q: 'Pop-quiz passed?', w: 1 }
      ]},
      { id: 'TSA', title: 'Skill Assessment', items: [
        { id: 'TSA_1', q: 'Hot & Cold stations working?', w: 1 },
        { id: 'TSA_2', q: 'Food station cleanliness?', w: 1 },
        { id: 'TSA_3', q: 'Customer Service quality?', w: 1 }
      ]},
      { id: 'CX', title: 'Customer Experience', items: [
        { id: 'CX_1', q: 'Music at right volume?', w: 1 },
        { id: 'CX_2', q: 'Temperature comfortable?', w: 1 },
        { id: 'CX_3', q: 'Washrooms clean?', w: 1 },
        { id: 'CX_4', q: 'Wi-Fi working?', w: 1 },
        { id: 'CX_5', q: 'VM elements correct?', w: 1 },
        { id: 'CX_6', q: 'Furniture well-kept?', w: 1 },
        { id: 'CX_7', q: 'Staff know metrics?', w: 1 },
        { id: 'CX_8', q: 'Latest Mystery Audit score?', w: 1 },
        { id: 'CX_9', q: 'Top 2 CX opps named?', w: 1 }
      ]},
      { id: 'AP', title: 'Action Plan', items: [
        { id: 'AP_1', q: 'Concerns addressed?', w: 2 },
        { id: 'AP_2', q: 'Managers aware?', w: 3 }
      ]}
    ]};

    function AuditForm() {
      const [storeName, setStoreName] = useState(localStorage.getItem('storeName') || '');
      const [storeId, setStoreId] = useState(localStorage.getItem('storeId') || '');
      const [responses, setResponses] = useState(JSON.parse(localStorage.getItem('responses')) || {});
      const [imgs, setImgs] = useState(JSON.parse(localStorage.getItem('imgs')) || {});

      useEffect(() => {
        localStorage.setItem('storeName', storeName);
        localStorage.setItem('storeId', storeId);
        localStorage.setItem('responses', JSON.stringify(responses));
        localStorage.setItem('imgs', JSON.stringify(imgs));
      }, [storeName, storeId, responses, imgs]);

      const updateResp = (id, score, na) => setResponses(prev => ({ ...prev, [id]: { score, na } }));
      const pickImages = (sectionId, e) => {
        Array.from(e.target.files).forEach(file => {
          const reader = new FileReader();
          reader.onload = () => setImgs(prev => ({
            ...prev,
            [sectionId]: [...(prev[sectionId] || []), reader.result]
          }));
          reader.readAsDataURL(file);
        });
      };

      const handleSubmit = async e => {
        e.preventDefault();
        let total = 0, max = 0;
        CHECKLIST.sections.forEach(sec => sec.items.forEach(it => {
          const r = responses[it.id] || { score: 0, na: false };
          if (!r.na) { total += r.score; max += it.w; }
        }));
        const pct = max ? Math.round((total / max) * 100) : 0;
        const params = new URLSearchParams(window.location.search);
        const auditorName = params.get('name') || '';
        const auditorId = params.get('id') || '';

        try {
          const paramsLog = new URLSearchParams({ auditorName, auditorId, storeName, storeId, total, pct });
          await fetch(`https://script.google.com/macros/s/AKfycby4oEhip48o_sQXoiZd0kOdkGTyiK9XeEfZkLdcKqY8Yaxy0qQP6B6CnycBZvUlry2N/exec?${paramsLog}`, { mode: 'no-cors' });
        } catch (err) {
          alert('Error logging results. PDF will not be generated.');
          console.error(err);
          return;
        }

        try {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          doc.setFontSize(16);
          doc.text(`Training Audit Report | ${storeName}`, doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
          doc.setFontSize(10);
          doc.text(`Auditor: ${auditorName} (ID ${auditorId})`, 20, 40);
          doc.text(`Store: ${storeName} (ID ${storeId})`, 140, 40);
          doc.text(`Score: ${total} / ${max} (${pct}%)`, 260, 40);

          const rows = [];
          CHECKLIST.sections.forEach(sec => sec.items.forEach(it => {
            const r = responses[it.id] || { score: 0, na: false };
            rows.push([sec.title, it.q, r.na ? 'NA' : (r.score === it.w ? 'Yes' : 'No'), r.score]);
          }));

          doc.autoTable({
            startY: 60,
            head: [['Section', 'Question', 'Response', 'Score']],
            body: rows,
            styles: { fontSize: 9, cellPadding: 4 },
            headStyles: { fillColor: [200, 200, 200], textColor: [0, 0, 0], halign: 'center' }
          });

          alert('Report downloaded');
          doc.save(`audit_${auditorId}_${Date.now()}.pdf`);
        } catch (err) {
          console.error(err);
        }

        localStorage.clear();
      };

      return (
        <form onSubmit={handleSubmit} className="space-y-6">
          <h1 className="text-3xl font-bold text-center mb-4">Training Audit Checklist</h1>
          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
            <input type="text" readOnly value={new URLSearchParams(window.location.search).get('name') || ''} placeholder="Auditor Name" className="p-2 border rounded bg-gray-200" />
            <input type="text" readOnly value={new URLSearchParams(window.location.search).get('id') || ''} placeholder="Auditor ID" className="p-2 border rounded bg-gray-200" />
            <input type="text" value={storeName} onChange={e => setStoreName(e.target.value)} required placeholder="Store Name" className="p-2 border rounded" />
            <input type="text" value={storeId} onChange={e => setStoreId(e.target.value)} required placeholder="Store ID" className="p-2 border rounded" />
          </div>
          {CHECKLIST.sections.map(section => (
            <section key={section.id} className="bg-white p-4 rounded shadow mb-6">
              <h2 className="text-xl font-semibold text-center mb-4">{section.title}</h2>
              <input type="file" accept="image/*" capture="environment" multiple onChange={e => pickImages(section.id, e)} className="mb-4" />
              <div className="flex space-x-2 mb-4">
                {(imgs[section.id] || []).map((src, idx) => (
                  <img key={idx} src={src} alt="preview" className="w-12 h-12 object-cover rounded shadow" />
                ))}
              </div>
              <table className="w-full table-auto border-collapse border border-gray-300">
                <thead>
                  <tr>
                    <th className="border p-2">Question</th>
                    <th className="border p-2">Yes</th>
                    <th className="border p-2">No</th>
                    <th className="border p-2">NA</th>
                  </tr>
                </thead>
                <tbody>
                  {section.items.map(item => {
                    const r = responses[item.id] || { score: null, na: false };
                    return (
                      <tr key={item.id} className="odd:bg-gray-50 hover:bg-gray-100">
                        <td className="border p-2">{item.q}</td>
                        {['Yes','No','NA'].map(label => {
                          const isYes = label === 'Yes';
                          const isNo = label === 'No';
                          const isNA = label === 'NA';
                          const selected = (isYes && r.score === item.w) || (isNo && r.score === 0 && !r.na) || (isNA && r.na);
                          let btnClasses = selected
                            ? isYes
                              ? 'bg-green-200 text-green-900'
                              : isNo
                                ? 'bg-red-200 text-red-900'
                                : 'bg-amber-200 text-amber-900'
                            : 'bg-gray-200 text-gray-700';
                          return (
                            <td key={label} className="border p-2 text-center">
                              <button type="button" className={`px-3 py-1 rounded ${btnClasses}`} onClick={() => updateResp(item.id, isYes ? item.w : 0, isNA)}>
                                {label}
                              </button>
                            </td>
                          );
                        })}
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </section>
          ))}
          <button type="submit" className="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg shadow flex items-center justify-center">
            Submit & Download PDF
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a1 1 0 001 1h14a1 1 0 001-1v-1M12 12v8m0-8l-3 3m3-3l3 3" />
            </svg>
          </button>
        </form>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<AuditForm />);
  </script>
</body>
</html>
