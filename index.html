<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Training Audit Checklist</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React + ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <!-- jsPDF + autoTable plugin -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    table { border-collapse: collapse; width: 100%; margin-bottom: 1rem; }
    th, td { border: 1px solid #e5e7eb; padding: 0.5rem; text-align: left; }
    th { background-color: #f3f4f6; }
    input[type="radio"] { margin-right: 0.25rem; }
    input[type="file"] { margin-top: 0.5rem; }
  </style>

  <script>
    // Checklist data
    window.CHECKLIST = {
      "name":"Training Audit Checklist","version":"1.0",
      "sections":[
        {"id":"Training Materials","title":"Training Materials","items":[
          {"id":"TM_1","question":"FRM available at store?","weight":1},
          {"id":"TM_2","question":"BRM available at store?","weight":1},
          {"id":"TM_3","question":"One-pager – Hot/Cue Cards displayed?","weight":1},
          {"id":"TM_4","question":"One-pager – Cold/Cue Cards displayed?","weight":1},
          {"id":"TM_5","question":"Dial-in One-pager visible?","weight":2},
          {"id":"TM_6","question":"New-launch learning material posted?","weight":1},
          {"id":"TM_7","question":"COFFEE Playbook in store?","weight":1},
          {"id":"TM_8","question":"Shelf-life chart displayed?","weight":1},
          {"id":"TM_9","question":"Career progression chart displayed?","weight":1}
        ]},
        {"id":"LMS","title":"LMS Usage","items":[
          {"id":"LMS_1","question":"Orientation & Induction completed within 3 days?","weight":4},
          {"id":"LMS_2","question":"All assessments & knowledge checks on LMS?","weight":4},
          {"id":"LMS_3","question":"Team uses LMS for new info & comms?","weight":2}
        ]},
        {"id":"Buddy","title":"Buddy Trainer Capabilities","items":[
          {"id":"Buddy_1","question":"≥2 certified Buddy Trainers in café?","weight":2},
          {"id":"Buddy_2","question":"Buddy Trainers passed skill checks?","weight":2},
          {"id":"Buddy_3","question":"Trainees rostered with Buddies?","weight":2},
          {"id":"Buddy_4","question":"Logbook up-to-date?","weight":1},
          {"id":"Buddy_5","question":"Badge worn during training?","weight":1},
          {"id":"Buddy_6","question":"Schedules visible?","weight":1},
          {"id":"Buddy_7","question":"Monthly feedback sessions?","weight":1}
        ]},
        {"id":"NewJoiner","title":"New Joiner Training","items":[
          {"id":"NJ_1","question":"Tracker updated?","weight":2},
          {"id":"NJ_2","question":"15-day cert completed?","weight":2},
          {"id":"NJ_3","question":"Skill gaps documented?","weight":1},
          {"id":"NJ_4","question":"Training wall current?","weight":1},
          {"id":"NJ_5","question":"Learning plan filed?","weight":1},
          {"id":"NJ_6","question":"Cert cards issued?","weight":1},
          {"id":"NJ_7","question":"Refresher logged?","weight":1}
        ]},
        {"id":"Partner","title":"Partner Knowledge","items":[
          {"id":"PK_1","question":"Team knows company comms?","weight":1},
          {"id":"PK_2","question":"Tasting & sampling done?","weight":1},
          {"id":"PK_3","question":"Sampling follows guidelines?","weight":1},
          {"id":"PK_4","question":"Tasting engaging?","weight":1},
          {"id":"PK_5","question":"Team knows manual brew?","weight":1},
          {"id":"PK_6","question":"Grooming standards met?","weight":1},
          {"id":"PK_7","question":"Pop-quiz passed?","weight":1}
        ]},
        {"id":"TSA","title":"Skill Assessment","items":[
          {"id":"TSA_1","question":"Hot & Cold stations","weight":1},
          {"id":"TSA_2","question":"Food station","weight":1},
          {"id":"TSA_3","question":"Customer Service","weight":1}
        ]},
        {"id":"CX","title":"Customer Experience","items":[
          {"id":"CX_1","question":"Music at right volume?","weight":1},
          {"id":"CX_2","question":"Temperature comfortable?","weight":1},
          {"id":"CX_3","question":"Washrooms clean?","weight":1},
          {"id":"CX_4","question":"Wi-Fi working?","weight":1},
          {"id":"CX_5","question":"VM elements correct?","weight":1},
          {"id":"CX_6","question":"Furniture well-kept?","weight":1},
          {"id":"CX_7","question":"Staff know key metrics?","weight":1},
          {"id":"CX_8","question":"Mystery Audit score known?","weight":1},
          {"id":"CX_9","question":"Top 2 CX opps named?","weight":1}
        ]},
        {"id":"Action","title":"Action Plan","items":[
          {"id":"AP_1","question":"Concerns addressed?","weight":2},
          {"id":"AP_2","question":"Managers aware?","weight":3}
        ]}
      ]
    };
  </script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div id="root" class="max-w-4xl mx-auto bg-white p-6 rounded shadow"></div>

  <script>
    const { useState, useEffect } = React;
    const checklist = window.CHECKLIST;
    if (!checklist || !Array.isArray(checklist.sections)) {
      console.error('Checklist sections missing or invalid');
      document.getElementById('root').innerHTML = '<p class="text-red-600">Error: Checklist data not loaded.</p>';
    }
    const params    = new URLSearchParams(location.search);
    const auditor   = { name: params.get('name')||'', id: params.get('id')||'' };
    const LOG_ENDPOINT = 'https://script.google.com/macros/s/AKfycby_IJdm8W5aKaL-lcm5Gd_aFWwyHPQ7Sz9IE8VDFLH2OWaX8pj9i2N_nnRVwjqqlTSB/exec';

    const KEY = `audit_${auditor.id}`;
    function freshResponses() {
      const obj = {};
      checklist.sections.forEach(sec =>
        sec.items.forEach(it => obj[it.id] = { score: null, na: false })
      );
      return obj;
    }

    function App() {
      const [resp, setResp] = useState(() => {
        try { return JSON.parse(localStorage.getItem(KEY)) || freshResponses(); }
        catch { return freshResponses(); }
      });
      const [storeName, setStoreName] = useState('');
      const [storeId,   setStoreId]   = useState('');

      useEffect(() => {
        localStorage.setItem(KEY, JSON.stringify(resp));
      }, [resp]);

      const upd = (id, patch) => setResp(r => ({ ...r, [id]: { ...r[id], ...patch } }));

      const handleSubmit = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(14);
        doc.text("Training Audit Report", 105, 10, { align: "center" });
        doc.setFontSize(10);
        doc.text(`Auditor: ${auditor.name} (ID ${auditor.id})`, 10, 20);
        doc.text(`Store:   ${storeName} (ID ${storeId})`, 10, 26);
        doc.text(`Time:    ${new Date().toLocaleString()}`, 10, 32);

        const rows = [];
        let totalScore = 0, maxScore = 0;
        checklist.sections.forEach(sec => {
          sec.items.forEach(it => {
            const r = resp[it.id];
            const ans = r.na ? "NA" : (r.score === it.weight ? "Yes" : "No");
            rows.push([sec.title, it.question, ans]);
            if (!r.na && r.score != null) {
              totalScore += r.score;
              maxScore   += it.weight;
            }
          });
        });

        doc.autoTable({ head: [['Section','Question','Response']], body: rows, startY: 40, styles: { fontSize: 8 } });
        const percentage = maxScore > 0 ? Math.round(100 * totalScore / maxScore) : 0;
        doc.setFontSize(11);
        doc.text(`Overall Score: ${totalScore} / ${maxScore} (${percentage}%)`, 10, doc.lastAutoTable.finalY + 10);

        // Log
        fetch(LOG_ENDPOINT, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ storeName, storeId, auditorName: auditor.name, auditorId: auditor.id, score: totalScore, percentage })
        });

        doc.save(`audit_${auditor.id}_${Date.now()}.pdf`);
        localStorage.removeItem(KEY);
      }; 

      return React.createElement(
        'form', 
        { onSubmit: e => { e.preventDefault(); handleSubmit(); }, className: 'space-y-8' },
        // form content...
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
  </script>
</body>
</html>