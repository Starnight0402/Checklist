<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Training Audit | Third wave coffee</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
  <style>
    .fade-in { opacity: 0; animation: fadeIn 0.6s forwards; }
    @keyframes fadeIn { to { opacity: 1; } }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const params = new URLSearchParams(window.location.search);
    const auditorName = params.get('auditorName') || '';
    const auditorId   = params.get('auditorId')   || '';

    const SECTIONS = [
      { id:'Training Materials', title:'Training Materials', items:[
        {id:'TM_1',q:'FRM available at store?',w:1},
        {id:'TM_2',q:'BRM available at store?',w:1},
        {id:'TM_3',q:'One-pager – Hot/Cue Cards displayed?',w:1},
        {id:'TM_4',q:'One-pager – Cold/Cue Cards displayed?',w:1},
        {id:'TM_5',q:'Dial-in One-pager visible?',w:2},
        {id:'TM_6',q:'New-launch learning material posted?',w:1},
        {id:'TM_7',q:'COFFEE & HD Playbook in store?',w:1},
        {id:'TM_8',q:'MSDS & Shelf life chart displayed?',w:1},
        {id:'TM_9',q:'Career Progression Chart & Reward Poster displayed?',w:1}
      ]},
      { id:'LMS', title:'LMS Usage', items:[
        {id:'LMS_1',q:'Orientation & Induction completed within 3 days of joining?',w:4},
        {id:'LMS_2',q:'All assessments & knowledge checks on LMS?',w:4},
        {id:'LMS_3',q:'Team uses LMS for new info & comms?',w:2}
      ]},
      { id:'Buddy', title:'Buddy Trainer Availability & Capability', items:[
        {id:'Buddy_1',q:'≥2 certified Buddy Trainers?',w:2},
        {id:'Buddy_2',q:'Buddy Trainers passed skill checks?',w:2},
        {id:'Buddy_3',q:'Trainees rostered with Buddies?',w:1},
        {id:'Buddy_4',q:'Buddy Trainers attended workshop?',w:2},
        {id:'Buddy_5',q:'Explain 4-step training process?',w:2},
        {id:'Buddy_6',q:'Navigate LMS flawlessly?',w:1}
      ]},
      { id:'NewJoiner', title:'New Joiner Training & Records', items:[
        {id:'NJ_1',q:'OJT book available for all partners?',w:1},
        {id:'NJ_2',q:'Trainees completing skill checks?',w:1},
        {id:'NJ_3',q:'Training aligned with plan?',w:1},
        {id:'NJ_4',q:'Aware of progressions?',w:1},
        {id:'NJ_5',q:'Managers completed SHLP training?',w:2},
        {id:'NJ_6',q:'≥2 FOSTAC-certified managers?',w:2},
        {id:'NJ_7',q:'ASM/SM training completed?',w:2}
      ]},
      { id:'PartnerKnowledge', title:'Partner Knowledge', items:[
        {id:'PK_1',q:'Aware of company communications?',w:2},
        {id:'PK_2',q:'Conduct Coffee Tasting & Sampling?',w:2},
        {id:'PK_3',q:'Sampling per guidelines?',w:2},
        {id:'PK_4',q:'Tasting engaging?',w:2},
        {id:'PK_5',q:'Aware of manual brew standards?',w:2},
        {id:'PK_6',q:'Partners follow grooming standards?',w:2},
        {id:'PK_7',q:'Pop-quiz key topics passed?',w:3}
      ]},
      { id:'TSA', title:'TSA - Training Skill Assessment', items:[
        {id:'TSA_1',q:'Hot & Cold stations work?',w:10},
        {id:'TSA_2',q:'Food station cleanliness?',w:10},
        {id:'TSA_3',q:'Customer Service quality?',w:10}
      ]},
      { id:'CustomerExperience', title:'Customer Experience', items:[
        {id:'CX_1',q:'Music at proper volume?',w:1},
        {id:'CX_2',q:'Temperature comfortable?',w:1},
        {id:'CX_3',q:'Washrooms clean?',w:1},
        {id:'CX_4',q:'Wi-Fi working?',w:1},
        {id:'CX_5',q:'VM displays correct?',w:2},
        {id:'CX_6',q:'Furniture well-kept?',w:1},
        {id:'CX_7',q:'Understanding MA/CPI/QA?',w:1},
        {id:'CX_8',q:'Latest Mystery Audit score?',w:1},
        {id:'CX_9',q:'Top 2 CX opps last month?',w:1}
      ]},
      { id:'ActionPlan', title:'Action Plan & Continuous Improvement', items:[
        {id:'AP_1',q:'Concerns addressed within 48hrs?',w:1},
        {id:'AP_2',q:'Action points closed/work-in-progress?',w:2},
        {id:'AP_3',q:'Managers aware of action plan?',w:2}
      ]}
    ];

    function App() {
      const [resp, setResp] = useState(() => JSON.parse(localStorage.getItem('resp') || '{}'));
      const [storeName, setStoreName] = useState(localStorage.getItem('storeName') || '');
      const [storeId, setStoreId] = useState(localStorage.getItem('storeId') || '');
      const [imgs, setImgs] = useState(() => JSON.parse(localStorage.getItem('imgs') || '{}'));

      useEffect(() => {
        const save = () => {
          localStorage.setItem('resp', JSON.stringify(resp));
          localStorage.setItem('storeName', storeName);
          localStorage.setItem('storeId', storeId);
          localStorage.setItem('imgs', JSON.stringify(imgs));
        };
        window.addEventListener('beforeunload', save);
        return () => window.removeEventListener('beforeunload', save);
      }, [resp, storeName, storeId, imgs]);

      const handleOption = (sec, it, val) => setResp(r => ({ ...r, [sec + '_' + it]: val }));
      const allDone = SECTIONS.every(sec => sec.items.every(it => resp[sec.id + '_' + it.id] != null));

      const handleSubmit = e => {
        e.preventDefault();
        if (!storeName.trim() || !storeId.trim() || !allDone) return;
        let total=0, max=0;
        SECTIONS.forEach(sec => sec.items.forEach(it => { const key=sec.id+'_'+it.id, r=resp[key]; if(sec.id==='TSA'){const v=parseInt(r)||0; total+=v; max+=it.w;}else{if(r==='yes') total+=it.w; if(r!=='na') max+=it.w;} }));
        const pct = max?Math.round(total/max*100):0;
        const { jsPDF }=window.jspdf; const doc=new jsPDF({orientation:'portrait'});
        const pageW = doc.internal.pageSize.getWidth();
        const pageH = doc.internal.pageSize.getHeight();

        // Header
        doc.setFontSize(18).setFont('helvetica','bold').setTextColor(0,0,0);
        doc.text('Training Audit | Third wave coffee', pageW/2, 15, {align:'center'});
        doc.setFontSize(12).setFont('helvetica','normal');
        doc.text(`Auditor: ${auditorName} (ID: ${auditorId})`, 12, 25);
        doc.text(`Store: ${storeName} (ID: ${storeId})`, 12, 31);
        doc.setFontSize(13).setFont('helvetica','bold');
        doc.text(`Overall Score: ${total}/${max}`, 12, 39);
        doc.text(`Percentage: ${pct}%`, 65, 39);

        let y = 45;
        SECTIONS.forEach(sec => {
          // PRE-CALCULATE: Estimate height needed for table+images for section
          const rows = sec.items.map(it => {
            const key = sec.id + '_' + it.id;
            const r = resp[key];
            const sc = sec.id === 'TSA' ? parseInt(r)||0 : (r === 'yes' ? it.w : 0);
            return [it.q, (r || '').toUpperCase(), sc.toString()];
          });
          let estTableH = 8 + (rows.length * 7);
          let estImgH = (imgs[sec.id]||[]).length ? Math.ceil((imgs[sec.id].length/6)) * 18 + 6 : 0;
          let boxH = 18 + estTableH + estImgH + 2;
          // If section would spill, start new page
          if (y + boxH > pageH - 15) { doc.addPage(); y = 15; }

          // Pastel section box
          const boxX = 10, boxW = pageW - 20;
          doc.setFillColor(235,245,255); // Pastel blue
          doc.roundedRect(boxX, y, boxW, boxH, 5, 5, 'F');
          doc.setDrawColor(130,170,240);
          doc.roundedRect(boxX, y, boxW, boxH, 5, 5);

          // Section Title centered inside box
          doc.setFont('helvetica', 'bold').setFontSize(13).setTextColor(25,25,25);
          doc.text(sec.title, boxX + boxW/2, y + 10, { align: 'center', baseline:'middle' });

          // Table in box, below title (with dark font for headings)
          const tableY = y + 15;
          doc.autoTable({
            startY: tableY,
            margin: { left: boxX+2, right: boxX+2 },
            tableWidth: boxW-4,
            head: [['Question','Response','Score']],
            body: rows,
            theme: 'grid',
            styles: { fontSize:8, textColor:[30,30,30], cellPadding:2 },
            headStyles: { fillColor:[200,220,245], textColor:[30,30,30], fontStyle:'bold', fontSize:9 },
            bodyStyles: { fillColor:[255,255,255] },
            pageBreak: 'avoid'
          });
          let tableH = doc.lastAutoTable.finalY - tableY;

          // Images inside box, under table
          let imgY = tableY + tableH + 3;
          let imgX = boxX + 3;
          if ((imgs[sec.id]||[]).length > 0) {
            (imgs[sec.id]||[]).forEach((src, i) => {
              if (imgX > boxX + boxW - 20) { imgX = boxX + 3; imgY += 18; }
              doc.addImage(src, 'JPEG', imgX, imgY, 15, 15, undefined, 'FAST');
              imgX += 17;
            });
          }
          y += boxH + 7;
        });

        // Download
        const url = doc.output('bloburl');
        const a = document.createElement('a');
        a.href = url;
        a.download = `audit_${storeName}_${Date.now()}.pdf`;
        a.click();
      };

      return (
        <form onSubmit={handleSubmit} className="p-6 bg-white shadow rounded fade-in mx-auto max-w-4xl space-y-6">
          <h1 className="text-2xl font-bold text-center">Training Audit | Third wave coffee</h1>
          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
            <div><label className="block text-sm">Auditor Name</label><input readOnly value={auditorName} className="w-full p-2 border rounded bg-gray-100"/></div>
            <div><label className="block text-sm">Auditor ID</label><input readOnly value={auditorId} className="w-full p-2 border rounded bg-gray-100"/></div>
            <div><label className="block text-sm">Store Name</label><input value={storeName} onChange={e=>setStoreName(e.target.value)} className="w-full p-2 border rounded"/></div>
            <div><label className="block text-sm">Store ID</label><input value={storeId} onChange={e=>setStoreId(e.target.value)} className="w-full p-2 border rounded"/></div>
          </div>
          {SECTIONS.map(sec=>(
            <section key={sec.id} className="mb-6">
              <h2 className="text-lg font-semibold border-b pb-1">{sec.title}</h2>
              <table className="w-full border-collapse mt-2">
                <thead><tr className="bg-gray-100"><th className="border px-2 py-1 text-left">Question</th>
                  {(sec.id==='TSA'? [10,5,0]: ['Yes','No','NA']).map(o=><th key={o} className="border px-2 py-1 text-center uppercase text-xs">{o}</th>)}
                </tr></thead>
                <tbody>
                  {sec.items.map(it=>{const key=sec.id+'_'+it.id;return(
                    <tr key={key} id={key} className="even:bg-gray-50 hover:bg-gray-50">
                      <td className="border px-2 py-1">{it.q}</td>
                      {(sec.id==='TSA'? [10,5,0]: ['yes','no','na']).map(val=>{const sel=resp[key]===String(val)||resp[key]===val;const color=sec.id==='TSA'?'blue':val==='yes'?'green':val==='no'?'red':'yellow';return(
                        <td key={val} className="border px-2 py-1 text-center">
                          <button type="button" onClick={()=>handleOption(sec.id,it.id,String(val))}
                            className={`px-2 py-0.5 text-xs rounded-full transition ${sel?`bg-${color}-200 ring-2 ring-${color}-500`:`bg-${color}-100`} hover:bg-${color}-300`}>{String(val).toUpperCase()}</button>
                        </td>
                      );})}
                    </tr>);
                  })}
                </tbody>
              </table>
              <div className="mt-4">
                <label className="block text-sm">Upload Images</label>
                <input type="file" accept="image/*" capture="environment" multiple onChange={e=>{Array.from(e.target.files).forEach(f=>{EXIF.getData(f,function(){const r=new FileReader();r.onload=ev=>setImgs(i=>({...i,[sec.id]:[...(i[sec.id]||[]),ev.target.result]}));r.readAsDataURL(f);});});e.target.value=null;}} className="mt-1"/>
                <div className="flex space-x-2 mt-2 overflow-auto">{(imgs[sec.id]||[]).map((s,i)=><img key={i} src={s} className="w-16 h-16 object-cover rounded border"/>)} </div>
              </div>
            </section>
          ))}
          <div className="flex gap-4">
            <button type="button" onClick={()=>{localStorage.clear();setResp({});setStoreName('');setStoreId('');setImgs({});}} className="flex-1 bg-blue-100 py-3 rounded-full hover:bg-blue-200">New Response</button>
            <button type="submit" disabled={!allDone} className="flex-1 bg-green-100 py-3 rounded-full hover:bg-green-200">Submit & Download PDF</button>
          </div>
        </form>
      );
    }
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
