<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Third Wave Coffee | Training Audit</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { background: linear-gradient(135deg,#f9f2ec,#eef9f2); font-family:sans-serif; margin:0; }
    .container { max-width:800px; margin:2rem auto; background:#fff; padding:1.5rem; border-radius:.75rem; }
    .logo { display:block; margin:0 auto 1rem; max-width:200px; }
    .title { text-align:center; font-size:2rem; font-weight:700; margin:.5rem 0; }
    .info-box { border:1px solid #e5e7eb; padding:1rem; border-radius:.75rem; margin-bottom:2rem; }
    .section { margin-bottom:2rem; border:1px solid #e5e7eb; border-radius:.75rem; padding:1rem; box-shadow:0 2px 8px rgba(0,0,0,0.05); }
    .section h2 { text-align:center; font-weight:700; margin-bottom:1rem; }
    table { border-collapse:collapse; width:100%; margin-bottom:1rem; }
    th,td { border:1px solid #e5e7eb; padding:.5rem; }
    th { background:#f3f4f6; }
    input[type=radio] { margin-right:.25rem; }
    .photo-preview { max-width:100px; margin:.5rem; border-radius:.25rem; }
    .submit-btn { background:#4f46e5; color:#fff; padding:.75rem 1.5rem; border:none; border-radius:.5rem; cursor:pointer; font-size:1rem; }
  </style>
</head>
<body>
  <div class="container" id="root"></div>

  <script>
  const { useState, useEffect } = React;
  const params = new URLSearchParams(location.search);
  const auditor = { name: params.get('name')||'', id: params.get('id')||'' };
  const KEY = `audit_${auditor.id}`;
  const LOG_ENDPOINT = 'https://script.google.com/macros/s/AKfycby_IJdm8W5aKaL-lcm5Gd_aFWwyHPQ7Sz9IE8VDFLH2OWaX8pj9i2N_nnRVwjqqlTSB/exec';

  const CHECKLIST = {
    name: 'Training Audit Checklist',
    version: '1.0',
    sections: [
      { id:'Training Materials', title:'Training Materials', items:[
        {id:'TM_1',question:'FRM available at store?',weight:1},
        {id:'TM_2',question:'BRM available at store?',weight:1},
        {id:'TM_3',question:'One-pager – Hot/Cue Cards displayed?',weight:1},
        {id:'TM_4',question:'One-pager – Cold/Cue Cards displayed?',weight:1},
        {id:'TM_5',question:'Dial-in One-pager visible?',weight:2},
        {id:'TM_6',question:'New-launch learning material posted?',weight:1},
        {id:'TM_7',question:'COFFEE Playbook in store?',weight:1},
        {id:'TM_8',question:'Shelf-life chart displayed?',weight:1},
        {id:'TM_9',question:'Career progression chart displayed?',weight:1}
      ]},
      { id:'LMS', title:'LMS Usage', items:[
        {id:'LMS_1',question:'Orientation & Induction completed within 3 days?',weight:4},
        {id:'LMS_2',question:'All assessments & knowledge checks on LMS?',weight:4},
        {id:'LMS_3',question:'Team uses LMS for new info & comms?',weight:2}
      ]},
      { id:'Buddy', title:'Buddy Trainer Capabilities', items:[
        {id:'Buddy_1',question:'≥2 certified Buddy Trainers in café?',weight:2},
        {id:'Buddy_2',question:'Buddy Trainers passed skill checks?',weight:2},
        {id:'Buddy_3',question:'Trainees rostered with Buddies?',weight:2},
        {id:'Buddy_4',question:'Logbook up-to-date?',weight:1},
        {id:'Buddy_5',question:'Badge worn during training?',weight:1},
        {id:'Buddy_6',question:'Schedules visible?',weight:1},
        {id:'Buddy_7',question:'Monthly feedback sessions?',weight:1}
      ]},
      { id:'NewJoiner', title:'New Joiner Training', items:[
        {id:'NJ_1',question:'Tracker updated?',weight:2},
        {id:'NJ_2',question:'15-day cert completed?',weight:2},
        {id:'NJ_3',question:'Skill gaps documented?',weight:1},
        {id:'NJ_4',question:'Training wall current?',weight:1},
        {id:'NJ_5',question:'Learning plan filed?',weight:1},
        {id:'NJ_6',question:'Cert cards issued?',weight:1},
        {id:'NJ_7',question:'Refresher logged?',weight:1}
      ]},
      { id:'Partner', title:'Partner Knowledge', items:[
        {id:'PK_1',question:'Team knows company comms?',weight:1},
        {id:'PK_2',question:'Tasting & sampling done?',weight:1},
        {id:'PK_3',question:'Sampling follows guidelines?',weight:1},
        {id:'PK_4',question:'Tasting engaging?',weight:1},
        {id:'PK_5',question:'Team knows manual brew?',weight:1},
        {id:'PK_6',question:'Grooming standards met?',weight:1},
        {id:'PK_7',question:'Pop-quiz passed?',weight:1}
      ]},
      { id:'TSA', title:'Skill Assessment', items:[
        {id:'TSA_1',question:'Hot & Cold stations working?',weight:1},
        {id:'TSA_2',question:'Food station cleanliness?',weight:1},
        {id:'TSA_3',question:'Customer Service quality?',weight:1}
      ]},
      { id:'CX', title:'Customer Experience', items:[
        {id:'CX_1',question:'Music at right volume?',weight:1},
        {id:'CX_2',question:'Temperature comfortable?',weight:1},
        {id:'CX_3',question:'Washrooms clean?',weight:1},
        {id:'CX_4',question:'Wi-Fi working?',weight:1},
        {id:'CX_5',question:'VM elements correct?',weight:1},
        {id:'CX_6',question:'Furniture well-kept?',weight:1},
        {id:'CX_7',question:'Staff know key metrics?',weight:1},
        {id:'CX_8',question:'Mystery Audit score known?',weight:1},
        {id:'CX_9',question:'Top 2 CX opps named?',weight:1}
      ]},
      { id:'AP', title:'Action Plan', items:[
        {id:'AP_1',question:'Concerns addressed?',weight:2},
        {id:'AP_2',question:'Managers aware?',weight:3}
      ]}
    ]
  };

  function freshResponses() {
    const obj = {};
    CHECKLIST.sections.forEach(sec =>
      sec.items.forEach(it => obj[it.id] = { score:null, na:false })
    );
    return obj;
  }

  function App() {
    const [resp,setResp] = useState(() => {
      try { return JSON.parse(localStorage.getItem(KEY))||freshResponses(); }
      catch { return freshResponses(); }
    });
    const [storeName,setStoreName]=useState('');
    const [storeId,setStoreId]=useState('');
    const [sectionImages,setSectionImages]=useState({});
    useEffect(()=>{ localStorage.setItem(KEY, JSON.stringify(resp)); },[resp]);

    const upd = (id,patch) => setResp(r => ({ ...r, [id]:{...r[id],...patch} }));
    const handleImage = (secId,e)=>{
      Array.from(e.target.files).forEach(file=>{
        const reader=new FileReader();
        reader.onload=evt=>{
          const imgEl=new Image();
          imgEl.onload=()=>{
            const canvas=document.createElement('canvas');
            const MAX_W=800;
            let [w,h]=[imgEl.width,imgEl.height];
            if(w>MAX_W){ h=h*MAX_W/w; w=MAX_W; }
            canvas.width=w; canvas.height=h;
            canvas.getContext('2d').drawImage(imgEl,0,0,w,h);
            const type=file.type.includes('png')?'image/png':'image/jpeg';
            const dataUrl=canvas.toDataURL(type,0.8);
            setSectionImages(prev=>{
              const arr=prev[secId]||[];
              return {...prev,[secId]:[...arr,dataUrl]};
            });
          };
          imgEl.src=evt.target.result;
        };
        reader.readAsDataURL(file);
      });
    };

    const handleSubmit=e=>{
      e.preventDefault();
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      const score=computeScore();
      doc.setFillColor(79,70,229);
      doc.rect(10,10,190,30,'F');
      doc.setTextColor(255,255,255);
      doc.setFontSize(24);
      doc.text(`Score: ${score}`,105,28,{align:'center'});
      doc.setFontSize(18);
      doc.setTextColor(0);
      doc.text(`Training audit report | ${storeName}`,105,45,{align:'center'});
      let y=60;
      CHECKLIST.sections.forEach(sec=>{
        y+=15; doc.setFontSize(16); doc.text(sec.title,105,y,{align:'center'}); y+=10;
        const rows=sec.items.map(it=>{
          const r=resp[it.id];
          const a=r.na?'NA':(r.score===it.weight?'Yes':'No');
          return [it.question,a];
        });
        doc.autoTable({
          startY:y, head:[['Question','Response']], body:rows,
          styles:{fontSize:8}, headStyles:{fillColor:[79,70,229],textColor:255},
          didParseCell:data=>{
            if(data.section==='body'&&data.column.index===1){
              const t=data.cell.text[0];
              if(t==='Yes') data.cell.styles.textColor=[0,128,0];
              if(t==='No') data.cell.styles.textColor=[255,0,0];
              if(t==='NA') data.cell.styles.textColor=[255,165,0];
            }
          }
        });
        y=doc.autoTable.previous.finalY+5;
        (sectionImages[sec.id]||[]).forEach(img=>{
          const fmt=img.startsWith('data:image/png')?'PNG':'JPEG';
          doc.addImage(img,fmt,15,y,50,30); y+=35;
        });
      });
      doc.save(`TWC_Audit_${auditor.id}_${Date.now()}.pdf`);

      const payload = {
        auditor,
        store: { name: storeName, id: storeId },
        scores: resp,
        overallScore: score,
        images: sectionImages,
        timestamp: Date.now()
      };

      fetch(LOG_ENDPOINT, {
        method: 'POST',
        body: JSON.stringify(payload)
      }).then(r => {
        if (r.ok) {
          alert('Submission logged successfully');
        } else {
          r.text().then(t => alert('Failed to log submission: ' + t));
        }
      }).catch(err => {
        alert('Error logging submission: ' + err.message);
      });
    };

    function computeScore(){
      let t=0,m=0;
      CHECKLIST.sections.forEach(sec=>sec.items.forEach(it=>{
        const r=resp[it.id];
        if(!r.na&&r.score!=null){ t+=r.score; m+=it.weight; }
      }));
      return `${t}/${m} (${m?Math.round(100*t/m):0}%)`;
    }

    return React.createElement('div',{className:'container'},
      React.createElement('img',{src:'data:image/png;base64,{logo_b64}',alt:'Logo',className:'logo'}),
      React.createElement('h1',{className:'title'},CHECKLIST.name),
      React.createElement('div',{className:'info-box'},
        React.createElement('div',{className:'grid grid-cols-2 mb-4'},
          React.createElement('div',null,React.createElement('label',{className:'block font-medium mb-1'},'Auditor Name'),
            React.createElement('input',{type:'text',value:auditor.name,readOnly:true,className:'w-full p-2 border rounded'})),
          React.createElement('div',null,React.createElement('label',{className:'block font-medium mb-1'},'Auditor ID'),
            React.createElement('input',{type:'text',value:auditor.id,readOnly:true,className:'w-full p-2 border rounded'}))
        ),
        React.createElement('div',{className:'grid grid-cols-2'},
          React.createElement('div',null,React.createElement('label',{className:'block font-medium mb-1'},'Store Name'),
            React.createElement('input',{type:'text',value:storeName,onChange:e=>setStoreName(e.target.value),required:true,className:'w-full p-2 border rounded'})),
          React.createElement('div',null,React.createElement('label',{className:'block font-medium mb-1'},'Store ID'),
            React.createElement('input',{type:'text',value:storeId,onChange:e=>setStoreId(e.target.value),required:true,className:'w-full p-2 border rounded'}))
        )
      ),
      React.createElement('form',{onSubmit:handleSubmit},
        CHECKLIST.sections.map(sec=>React.createElement('div',{key:sec.id,className:'section'},
          React.createElement('h2',null,sec.title),
          React.createElement('table',null,
            React.createElement('thead',null,React.createElement('tr',null,
              React.createElement('th',null,'Question'),
              React.createElement('th',null,'Yes'),
              React.createElement('th',null,'No'),
              React.createElement('th',null,'NA'))),
            React.createElement('tbody',null,sec.items.map(it=>{
              const r=resp[it.id];
              return React.createElement('tr',{key:it.id},
                React.createElement('td',null,it.question),
                React.createElement('td',{className:'text-center'},React.createElement('input',{type:'radio',name:it.id,value:'yes',required:true,checked:r.score===it.weight,onChange:()=>upd(it.id,{score:it.weight,na:false})})),
                React.createElement('td',{className:'text-center'},React.createElement('input',{type:'radio',name:it.id,value:'no',checked:r.score===0&&!r.na,onChange:()=>upd(it.id,{score:0,na:false})})),
                React.createElement('td',{className:'text-center'},React.createElement('input',{type:'radio',name:it.id,value:'na',checked:r.na,onChange:()=>upd(it.id,{na:true,score:null})}))
              );
            }))
          ),
          React.createElement('input',{type:'file',accept:'image/*',capture:'environment',multiple:true,onChange:e=>handleImage(sec.id,e)}),
          React.createElement('div',null,(sectionImages[sec.id]||[]).map((src,i)=>React.createElement('img',{key:i,src:src,className:'photo-preview'})))
        )),
        React.createElement('button',{type:'submit',className:'submit-btn'},'Submit & Download PDF')
      )
    );
  }}
  ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
  </script>
</body>
</html>
