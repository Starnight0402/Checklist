<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Training Audit Checklist</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-50 p-6">
  <div id="root" class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const CHECKLIST = { sections: [
      { id: 'Training Materials', title: 'Training Materials', items: [
        { id: 'TM_1', q: 'FRM available at store?', w: 1 },
        { id: 'TM_2', q: 'BRM available at store?', w: 1 },
        { id: 'TM_3', q: 'One-pager – Hot/Cue Cards displayed?', w: 1 },
        { id: 'TM_4', q: 'One-pager – Cold/Cue Cards displayed?', w: 1 },
        { id: 'TM_5', q: 'Dial-in One-pager visible?', w: 2 },
        { id: 'TM_6', q: 'New-launch learning material posted?', w: 1 },
        { id: 'TM_7', q: 'COFFEE Playbook in store?', w: 1 },
        { id: 'TM_8', q: 'Shelf-life chart displayed?', w: 1 },
        { id: 'TM_9', q: 'Career progression chart displayed?', w: 1 }
      ]},
      { id: 'LMS', title: 'LMS Usage', items: [
        { id: 'LMS_1', q: 'Orientation & Induction completed within 3 days?', w: 4 },
        { id: 'LMS_2', q: 'All assessments & knowledge checks on LMS?', w: 4 },
        { id: 'LMS_3', q: 'Team uses LMS for new info & comms?', w: 2 }
      ]},
      { id: 'Buddy', title: 'Buddy Trainer Capabilities', items: [
        { id: 'Buddy_1', q: '≥2 certified Buddy Trainers in café?', w: 2 },
        { id: 'Buddy_2', q: 'Buddy Trainers passed skill checks?', w: 2 },
        { id: 'Buddy_3', q: 'Trainees rostered with Buddies?', w: 2 },
        { id: 'Buddy_4', q: 'Logbook up-to-date?', w: 1 },
        { id: 'Buddy_5', q: 'Badge worn during training?', w: 1 },
        { id: 'Buddy_6', q: 'Schedules visible?', w: 1 },
        { id: 'Buddy_7', q: 'Monthly feedback sessions?', w: 1 }
      ]},
      { id: 'NewJoiner', title: 'New Joiner Training', items: [
        { id: 'NJ_1', q: 'Tracker updated?', w: 2 },
        { id: 'NJ_2', q: '15-day cert completed?', w: 2 },
        { id: 'NJ_3', q: 'Skill gaps documented?', w: 1 },
        { id: 'NJ_4', q: 'Training wall current?', w: 1 },
        { id: 'NJ_5', q: 'Learning plan filed?', w: 1 },
        { id: 'NJ_6', q: 'Cert cards issued?', w: 1 },
        { id: 'NJ_7', q: 'Refresher logged?', w: 1 }
      ]},
      { id: 'Partner', title: 'Partner Knowledge', items: [
        { id: 'PK_1', q: 'Team knows company comms?', w: 1 },
        { id: 'PK_2', q: 'Tasting & sampling done?', w: 1 },
        { id: 'PK_3', q: 'Sampling follows guidelines?', w: 1 },
        { id: 'PK_4', q: 'Tasting engaging?', w: 1 },
        { id: 'PK_5', q: 'Team knows manual brew?', w: 1 },
        { id: 'PK_6', q: 'Grooming standards met?', w: 1 },
        { id: 'PK_7', q: 'Pop-quiz passed?', w: 1 }
      ]},
      { id: 'TSA', title: 'Skill Assessment', items: [
        { id: 'TSA_1', q: 'Hot & Cold stations work?', w: 1 },
        { id: 'TSA_2', q: 'Food station cleanliness?', w: 1 },
        { id: 'TSA_3', q: 'Customer Service quality?', w: 1 }
      ]},
      { id: 'CX', title: 'Customer Experience', items: [
        { id: 'CX_1', q: 'Music at right volume?', w: 1 },
        { id: 'CX_2', q: 'Temperature comfortable?', w: 1 },
        { id: 'CX_3', q: 'Washrooms clean?', w: 1 },
        { id: 'CX_4', q: 'Wi-Fi working?', w: 1 },
        { id: 'CX_5', q: 'VM elements correct?', w: 1 },
        { id: 'CX_6', q: 'Furniture well-kept?', w: 1 },
        { id: 'CX_7', q: 'Staff know metrics?', w: 1 },
        { id: 'CX_8', q: 'Latest Mystery Audit score?', w: 1 },
        { id: 'CX_9', q: 'Top 2 CX opps named?', w: 1 }
      ]},
      { id: 'AP', title: 'Action Plan', items: [
        { id: 'AP_1', q: 'Concerns addressed?', w: 2 },
        { id: 'AP_2', q: 'Managers aware?', w: 3 }
      ]}
    ]};

    function AuditForm() {
      const params = new URLSearchParams(window.location.search);
      const auditorName = params.get('name') || '';
      const auditorId = params.get('id') || '';
      const [storeName, setStoreName] = useState(localStorage.getItem('storeName') || '');
      const [storeId, setStoreId] = useState(localStorage.getItem('storeId') || '');
      const [responses, setResponses] = useState(JSON.parse(localStorage.getItem('responses')) || {});
      const [imgs, setImgs] = useState(JSON.parse(localStorage.getItem('imgs')) || {});

      useEffect(() => {
        const save = () => {
          localStorage.setItem('storeName', storeName);
          localStorage.setItem('storeId', storeId);
          localStorage.setItem('responses', JSON.stringify(responses));
          localStorage.setItem('imgs', JSON.stringify(imgs));
        };
        window.addEventListener('beforeunload', save);
        return () => window.removeEventListener('beforeunload', save);
      }, [storeName, storeId, responses, imgs]);

      const updateResp = (id, score, na, vib) => {
        if (vib==='yes') navigator.vibrate(50);
        if (vib==='no') navigator.vibrate([50,50]);
        setResponses(prev=>({...prev,[id]:{score,na}}));
      };

      const pickImages = (secId,e)=>{
        Array.from(e.target.files).forEach(file=>{
          EXIF.getData(file,function(){
            const orient=EXIF.getTag(this,'Orientation')||1;
            const reader=new FileReader();reader.onload=async ev=>{
              let src=ev.target.result;
              if(orient!==1){
                const img=new Image();img.onload=()=>{
                  const c=document.createElement('canvas'),ctx=c.getContext('2d');
                  c.width=img.width; c.height=img.height;
                  ctx.drawImage(img,0,0);
                  src=c.toDataURL('image/jpeg');
                  setImgs(prev=>({...prev,[secId]:[...(prev[secId]||[]),src]}));
                };img.src=src;
              } else setImgs(prev=>({...prev,[secId]:[...(prev[secId]||[]),src]}));
            };reader.readAsDataURL(file);
          });
        });e.target.value=null;
      };

      const allAnswered = CHECKLIST.sections.every(sec=>sec.items.every(it=>{
        const r=responses[it.id]||{score:null,na:false};return r.score!==null||r.na;
      }));

      const handleSubmit=async e=>{
        e.preventDefault();navigator.vibrate&&navigator.vibrate(100);
        if(!allAnswered){alert('Please answer all questions.');return;}
        let total=0,max=0,yes=0,no=0,na=0;
        CHECKLIST.sections.forEach(sec=>sec.items.forEach(it=>{
          const r=responses[it.id]||{score:0,na:false};
          if(r.na)na++;else{total+=r.score;max+=it.w;r.score===it.w?yes++:no++;}
        }));
        const pct=max?Math.round(total/max*100):0;
        try{await fetch('https://script.google.com/macros/s/AKfycbw3DkJa6FIZwTnAhelY_h0UcUTozRaC3xETOOO0WgXNwFUm8ZoQw2cKTm1v1bA5ITgp/exec',{
          method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({auditorName,auditorId,storeName,storeId,total,pct})
        });}catch{}
        const doc=new window.jspdf.jsPDF();
        doc.setFontSize(16);doc.text(`Training Audit Report | ${storeName}`,doc.internal.pageSize.getWidth()/2,20,{align:'center'});
        doc.setFontSize(10);doc.text(`Auditor: ${auditorName} (ID ${auditorId})`,20,40);doc.text(`Store: ${storeName} (ID ${storeId})`,140,40);
        doc.setFontSize(14);doc.text(`Score: ${total} / ${max} (${pct}%)`,doc.internal.pageSize.getWidth()/2,55,{align:'center'});
        let y=65;
        CHECKLIST.sections.forEach(sec=>{
          doc.setFontSize(12);doc.text(sec.title,20,y);y+=6;
          (imgs[sec.id]||[]).forEach(src=>{doc.addImage(src,'JPEG',20,y,30,30);y+=34;if(y>doc.internal.pageSize.getHeight()-40){doc.addPage();y=20;}});
          const rows=sec.items.map(it=>{const r=responses[it.id]||{score:0,na:false};return[it.q,r.na?'NA':(r.score===it.w?'Yes':'No'),r.na?'NA':r.score];});
          doc.autoTable({startY:y,head:[['Question','Response','Score']],body:rows,styles:{fontSize:9,cellPadding:4},headStyles:{fillColor:[200,200,200]}});
          y=doc.lastAutoTable.finalY+10;if(y>doc.internal.pageSize.getHeight()-40){doc.addPage();y=20;}
        });
        alert('Report logged and downloaded');doc.save(`audit_${auditorId}_${Date.now()}.pdf`);localStorage.clear();
      };

      return(
        <form onSubmit={handleSubmit} className="space-y-6">
          <h1 className="text-3xl font-bold text-center mb-4">Training Audit Checklist</h1>
          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
            <input readOnly value={auditorName} className="p-2 border rounded bg-gray-200"/>
            <input readOnly value={auditorId} className="p-2 border rounded bg-gray-200"/>
            <input value={storeName} onChange={e=>setStoreName(e.target.value)} required placeholder="Store Name" className="p-2 border rounded"/>
            <input value={storeId} onChange={e=>setStoreId(e.target.value)} required placeholder="Store ID" className="p-2 border rounded"/>
          </div>
          {CHECKLIST.sections.map(sec=>(
            <section key={sec.id} className="bg-white p-4 rounded shadow mb-6">
              <h2 className="text-xl font-semibold text-center mb-4">{sec.title}</h2>
              <input type="file" accept="image/*" capture="environment" multiple onChange={e=>pickImages(sec.id,e)} className="mb-4"/>
              <div className="flex space-x-2 mb-4">{(imgs[sec.id]||[]).map((src,i)=><img key={i} src={src} className="w-12 h-12 rounded shadow"/>)}</div>
              <table className="w-full table-auto border-collapse border border-gray-300 text-sm">
                <thead>
                  <tr><th className="border p-2">Question</th><th className="border p-2">Yes</th><th className="border p-2">No</th><th className="border p-2">NA</th></tr>
                </thead>
                <tbody>
                  {sec.items.map(it=>{const r=responses[it.id]||{score:null,na:false};const yesSel=r.score===it.w;const noSel=r.score===0&&!r.na;const naSel=r.na;return(
                    <tr key={it.id} className="odd:bg-gray-50 hover:bg-gray-100">
                      <td className="border p-2 align-middle">{it.q}</td>
                      <td className="border p-2 align-middle"><button type="button" className={`w-full py-1 rounded-lg ${yesSel?'bg-green-200 text-green-800':'bg-gray-200 text-gray-600 hover:bg-green-100'}`} onClick={()=>updateResp(it.id,it.w,false,'yes')}>Yes</button></td>
                      <td className="border p-2 align-middle"><button type="button" className={`w-full py-1 rounded-lg ${noSel?'bg-red-200 text-red-800':'bg-gray-200 text-gray-600 hover:bg-red-100'}`} onClick={()=>updateResp(it.id,0,false,'no')}>No</button></td>
                      <td className="border p-2 align-middle"><button type="button" className={`w-full py-1 rounded-lg ${naSel?'bg-amber-200 text-amber-800':'bg-gray-200 text-gray-600 hover:bg-amber-100'}`} onClick={()=>updateResp(it.id,0,true)}>NA</button></td>
                    </tr>);})}
                </tbody>
              </table>
            </section>
          ))}
          <div className="flex flex-col sm:flex-row gap-4">
            <button
              type="button"
              onClick={() => {setStoreName(''); setStoreId(''); setResponses({}); setImgs({}); localStorage.clear();}}
              className="w-full sm:w-1/2 bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg shadow"
            >New Response</button>
            <button
              type="submit"
              disabled={!allAnswered}
              className={`w-full sm:w-1/2 ${allAnswered?'bg-green-500 hover:bg-green-600':'bg-gray-400 cursor-not-allowed'} text-white py-3 rounded-lg shadow`}
            >Submit & Download PDF</button>
          </div>
        </form>
      );
    }
    ReactDOM.createRoot(document.getElementById('root')).render(<AuditForm/>);
  </script>
</body>
</html>
